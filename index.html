<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pro BOM Explorer</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
    :root {
        --bg-main: #0f172a;
        --bg-panel: #1e293b;
        --bg-hover: #334155;
        --border: #334155;
        --accent: #38bdf8;
        --accent-glow: rgba(56, 189, 248, 0.15);
        --text-main: #f1f5f9;
        --text-muted: #94a3b8;
        --guide-line: #334155;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-main);
        color: var(--text-main);
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    /* Tree Guide Lines */
    .tree-branch {
        position: relative;
        padding-left: 24px;
    }
    .tree-branch::before {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: 11px;
        width: 1px;
        background-color: var(--guide-line);
        transition: background-color 0.2s;
    }
    .tree-branch:last-child::before {
        height: 18px; /* Stop line at the last item's connector */
    }
    
    /* Horizontal Connector */
    .tree-node-wrapper {
        position: relative;
    }
    .tree-node-wrapper::before {
        content: '';
        position: absolute;
        top: 50%;
        left: -13px;
        width: 12px;
        height: 1px;
        background-color: var(--guide-line);
    }
    
    /* Root level cleanup */
    .tree-root > .tree-branch::before { display: none; }
    .tree-root > .tree-branch > .tree-node-wrapper::before { display: none; }

    /* Node Styling */
    .tree-node {
        display: flex;
        align-items: center;
        padding: 6px 8px;
        border-radius: 6px;
        cursor: pointer;
        user-select: none;
        transition: all 0.15s ease;
        border: 1px solid transparent;
    }
    .tree-node:hover {
        background-color: var(--bg-hover);
    }
    .tree-node.active {
        background-color: var(--accent-glow);
        border-color: rgba(56, 189, 248, 0.3);
    }
    
    /* Icons */
    .icon-box {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 8px;
        border-radius: 4px;
    }
    .type-assy { color: #facc15; } /* Yellow for assembly */
    .type-part { color: #38bdf8; } /* Blue for part */

    /* Utilities */
    .mono { font-family: 'JetBrains Mono', monospace; }
    
    /* Modal Animation */
    .modal-backdrop {
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(4px);
    }

    /* Split Pane Resizer (Visual only for now) */
    .resizer {
        width: 4px;
        background: var(--bg-main);
        cursor: col-resize;
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
    }
    
    .search-match {
        color: #fff;
        font-weight: 600;
        text-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
    }
    
    .hidden-node { display: none !important; }
</style>
</head>
<body>

    <header class="h-14 bg-[var(--bg-panel)] border-b border-[var(--border)] flex items-center justify-between px-4 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center text-white font-bold shadow-lg">B</div>
            <h1 class="font-semibold text-lg tracking-tight">BOM Explorer</h1>
        </div>

        <div class="flex items-center gap-3">
            <div class="relative group">
                <input type="text" id="searchInput" placeholder="Search components..." 
                    class="bg-[var(--bg-main)] border border-[var(--border)] rounded-md pl-9 pr-4 py-1.5 text-sm w-64 focus:outline-none focus:border-[var(--accent)] transition-colors">
                <svg class="w-4 h-4 text-[var(--text-muted)] absolute left-3 top-1/2 -translate-y-1/2 group-focus-within:text-[var(--accent)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            
            <div class="h-6 w-px bg-[var(--border)] mx-1"></div>

            <button onclick="toggleImportModal()" class="flex items-center gap-2 px-3 py-1.5 rounded-md bg-[var(--accent)] text-[var(--bg-main)] text-sm font-semibold hover:bg-[#22d3ee] transition-colors shadow-lg shadow-cyan-900/20">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                Import Data
            </button>
            <button onclick="exportJSON()" class="p-2 text-[var(--text-muted)] hover:text-[var(--text-main)] hover:bg-[var(--bg-hover)] rounded-md transition-colors" title="Export JSON">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <aside class="flex-1 flex flex-col min-w-[300px] max-w-[60%] bg-[var(--bg-panel)] overflow-hidden">
            <div class="p-3 border-b border-[var(--border)] flex justify-between items-center text-xs text-[var(--text-muted)] bg-[var(--bg-panel)] z-10">
                <span id="treeStats">Waiting for data...</span>
                <div class="flex gap-1">
                    <button onclick="expandAll()" class="p-1 hover:bg-[var(--bg-hover)] rounded" title="Expand All">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <button onclick="collapseAll()" class="p-1 hover:bg-[var(--bg-hover)] rounded" title="Collapse All">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
                    </button>
                </div>
            </div>
            <div id="treeContainer" class="flex-1 overflow-auto p-4 pb-20">
                <div class="flex flex-col items-center justify-center h-full text-[var(--text-muted)] opacity-50">
                    <svg class="w-16 h-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                    <p>Import BOM data to start</p>
                </div>
            </div>
        </aside>

        <div class="resizer"></div>

        <aside id="detailsPanel" class="w-[400px] bg-[var(--bg-main)] border-l border-[var(--border)] flex flex-col overflow-hidden transition-all">
            <div class="h-full flex flex-col items-center justify-center text-[var(--text-muted)] p-8 text-center" id="emptyDetails">
                <svg class="w-12 h-12 mb-3 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <p>Select a component in the tree to view details</p>
            </div>

            <div id="contentDetails" class="hidden h-full flex flex-col">
                <div class="px-6 py-3 border-b border-[var(--border)] bg-[var(--bg-panel)] overflow-x-auto whitespace-nowrap">
                    <div id="breadcrumbs" class="flex items-center text-xs text-[var(--text-muted)] font-mono"></div>
                </div>

                <div class="p-6 border-b border-[var(--border)]">
                    <div class="flex items-start justify-between mb-2">
                        <span id="detailBadge" class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-blue-500/20 text-blue-400">Component</span>
                        <span id="detailLevel" class="text-xs text-[var(--text-muted)] font-mono">Lvl 3</span>
                    </div>
                    <h2 id="detailName" class="text-2xl font-bold text-white mb-1 font-mono tracking-tight">PART-NAME</h2>
                    <p id="detailDesc" class="text-[var(--text-muted)] text-sm">Description goes here</p>
                </div>

                <div class="grid grid-cols-2 gap-px bg-[var(--border)] border-b border-[var(--border)]">
                    <div class="bg-[var(--bg-main)] p-4">
                        <span class="block text-xs text-[var(--text-muted)] uppercase tracking-wider mb-1">Quantity</span>
                        <span id="detailQty" class="text-xl font-semibold text-[var(--accent)]">0</span>
                        <span id="detailUom" class="text-xs text-[var(--text-muted)] ml-1">EA</span>
                    </div>
                    <div class="bg-[var(--bg-main)] p-4">
                        <span class="block text-xs text-[var(--text-muted)] uppercase tracking-wider mb-1">Extended Qty</span>
                        <span id="detailExtQty" class="text-xl font-semibold text-white">0</span>
                        <span class="text-xs text-[var(--text-muted)] ml-1 block mt-1 leading-none opacity-60">per root assy</span>
                    </div>
                </div>

                <div class="p-6 overflow-auto">
                    <h3 class="text-sm font-semibold text-white mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4 text-[var(--text-muted)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                        Technical Data
                    </h3>
                    <div class="bg-[var(--bg-panel)] rounded-lg border border-[var(--border)] overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <tbody class="divide-y divide-[var(--border)]" id="detailTable">
                                </tbody>
                        </table>
                    </div>
                    
                    <div id="childrenSection" class="mt-6 hidden">
                         <h3 class="text-sm font-semibold text-white mb-3">Contains</h3>
                         <div id="childrenList" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
                
                <div class="mt-auto p-4 border-t border-[var(--border)] bg-[var(--bg-panel)]">
                     <button onclick="copyDetailJSON()" class="w-full py-2 rounded border border-[var(--border)] text-sm text-[var(--text-muted)] hover:text-white hover:border-[var(--text-muted)] transition-colors">Copy Object JSON</button>
                </div>
            </div>
        </aside>
    </main>

    <div id="importModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[var(--bg-panel)] border border-[var(--border)] rounded-xl w-full max-w-2xl shadow-2xl transform transition-all scale-100">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Import BOM Data</h2>
                    <button onclick="toggleImportModal()" class="text-[var(--text-muted)] hover:text-white">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                
                <div class="mb-4">
                     <div class="flex gap-4 mb-2">
                        <label class="flex items-center gap-2 cursor-pointer bg-[var(--bg-main)] border border-[var(--border)] px-4 py-2 rounded hover:border-[var(--accent)] transition-colors">
                            <input type="file" id="fileInput" accept=".txt,.csv,.tsv" class="hidden" onchange="handleFileUpload(this)">
                            <svg class="w-4 h-4 text-[var(--accent)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                            <span class="text-sm">Upload File</span>
                        </label>
                        <button onclick="loadSample()" class="text-sm text-[var(--text-muted)] hover:text-[var(--accent)] underline">Load Sample Data</button>
                     </div>
                </div>

                <textarea id="rawInput" class="w-full h-64 bg-[var(--bg-main)] border border-[var(--border)] rounded-lg p-4 font-mono text-xs text-[var(--text-muted)] focus:outline-none focus:border-[var(--accent)] focus:ring-1 focus:ring-[var(--accent)] resize-none" 
                placeholder="Paste tab-separated BOM data here...&#10;&#10;Format: Level | Component | Description | Qty | UoM"></textarea>
                
                <div class="mt-4 flex justify-end gap-3">
                    <button onclick="toggleImportModal()" class="px-4 py-2 rounded text-sm font-medium text-[var(--text-muted)] hover:text-white">Cancel</button>
                    <button onclick="processData()" class="px-6 py-2 rounded bg-[var(--accent)] text-[var(--bg-main)] text-sm font-bold hover:bg-[#22d3ee] shadow-lg shadow-cyan-900/20">Build Tree</button>
                </div>
            </div>
        </div>
    </div>

<script>
// --- State Management ---
let rawData = [];
let treeStructure = [];
let flatMap = new Map();
let selectedNodeId = null;

// --- Sample Data ---
const sampleData = `BOM\tLevel\t\t\tComponent\tDescription\tQty\t\tUoM
ASSY-001\t1\t\t\tMAIN-ROBOT-ARM\t6-Axis Robotic Arm Assembly\t1\t\tEA
\tPART-100\t2\t\t\tBASE-FRAME-01\tHeavy Duty Steel Base\t1\t\tEA
\t\tBRKT-101\t3\t\tMNT-BRACKET-A\tL-Shape Mounting Bracket\t4\t\tEA
\t\tFAST-102\t3\t\tSCREW-M4-10\tM4x10 Hex Socket Screw\t16\t\tEA
\t\tWASH-103\t3\t\tWASHER-M4\tM4 Split Lock Washer\t32\t\tEA
\tPART-200\t2\t\t\tACTUATOR-ASSY\tMain Axis Actuator Unit\t1\t\tEA
\t\tMOTR-201\t3\t\tDC-SERVO-12V\tHigh Torque DC Servo\t1\t\tEA
\t\tCABL-202\t3\t\tPOWER-HARNESS\tShielded Power Cable 2m\t1\t\tM
\t\tGEAR-BOX\t3\t\tGEARBOX-20:1\tPlanetary Gearbox Assembly\t1\t\tEA
\t\t\tGEAR-A\t4\t\tSUN-GEAR\tSteel Sun Gear 12T\t1\t\tEA
\t\t\tGEAR-B\t4\t\tPLANET-GEAR\tBrass Planet Gear 24T\t3\t\tEA
\t\t\tRING-C\t4\t\tRING-GEAR\tInternal Ring Gear\t1\t\tEA
\tPART-300\t2\t\t\tELEC-MODULE\tControl Electronics Box\t1\t\tEA
\t\tPCBA-301\t3\t\tMAIN-CONTROLLER\tPCB Assembly v2.4\t1\t\tEA
\t\tIC-302\t4\t\tMCU-ARM-M4\tMicrocontroller Unit\t1\t\tEA
\t\tIC-303\t4\t\tV-REG-5V\tVoltage Regulator 5V\t3\t\tEA
\t\tRES-SET\t4\t\tRESISTOR-KIT\tStandard 0603 Resistors\t1\t\tEA`;

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    // Show modal on start if empty
    toggleImportModal();
});

// --- Modal & Data Handling ---
function toggleImportModal() {
    const modal = document.getElementById('importModal');
    modal.classList.toggle('hidden');
    if (!modal.classList.contains('hidden')) {
        document.getElementById('rawInput').focus();
    }
}

function loadSample() {
    document.getElementById('rawInput').value = sampleData;
}

function handleFileUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('rawInput').value = e.target.result;
    };
    reader.readAsText(file);
}

function processData() {
    const raw = document.getElementById('rawInput').value.trim();
    if (!raw) return alert("Please enter data");

    const lines = raw.split('\n');
    let rows = lines.map(l => l.split('\t'));

    // Strip header if present (naive check)
    if (rows[0] && (rows[0][1] === 'Level' || isNaN(parseInt(rows[0][1])))) {
        rows.shift();
    }

    rawData = [];
    flatMap.clear();
    
    // Pass 1: Normalize Data
    rows.forEach((r, idx) => {
        const level = parseInt(r[1]);
        if (isNaN(level)) return;

        // Try to find columns dynamically or fallback to fixed indices
        // Fallback: Col 4=Component, 5=Desc, 6=Qty, 8=UoM (based on user sample)
        const id = `node-${idx}`;
        const item = {
            id: id,
            level: level,
            component: r[4] ? r[4].trim() : 'UNKNOWN',
            description: r[5] ? r[5].trim() : '',
            qty: parseFloat(r[6]) || 0,
            uom: r[8] ? r[8].trim() : 'EA',
            children: [],
            parent: null,
            path: [], // Breadcrumbs
            extendedQty: 0 // Will calc later
        };
        rawData.push(item);
    });

    // Pass 2: Build Hierarchy
    const rootNodes = [];
    const levelMap = {}; // Tracks last node at each level

    rawData.forEach(item => {
        if (item.level === 1) {
            rootNodes.push(item);
            item.extendedQty = item.qty; // Root qty is base
        } else {
            // Find parent: the last node seen at level - 1
            const parent = levelMap[item.level - 1];
            if (parent) {
                parent.children.push(item);
                item.parent = parent;
                item.extendedQty = parent.extendedQty * item.qty;
            } else {
                // Orphan handling: treat as root or attach to generic root
                rootNodes.push(item); 
                item.extendedQty = item.qty;
            }
        }
        levelMap[item.level] = item;
        flatMap.set(item.id, item);
    });

    treeStructure = rootNodes;
    
    // Pass 3: Calculate breadcrumbs
    rawData.forEach(item => {
        let curr = item;
        const path = [];
        while(curr) {
            path.unshift(curr.component);
            curr = curr.parent;
        }
        item.path = path;
    });

    renderTree();
    updateStats();
    toggleImportModal();
    
    // Reset view
    document.getElementById('contentDetails').classList.add('hidden');
    document.getElementById('emptyDetails').classList.remove('hidden');
}

// --- Rendering ---
function renderTree() {
    const container = document.getElementById('treeContainer');
    container.innerHTML = '';
    
    const rootUl = document.createElement('div');
    rootUl.className = 'tree-root';
    
    treeStructure.forEach(node => {
        rootUl.appendChild(createTreeNode(node));
    });
    
    container.appendChild(rootUl);
}

function createTreeNode(node) {
    const wrapper = document.createElement('div');
    wrapper.className = 'tree-branch';
    
    // Node Content
    const nodeEl = document.createElement('div');
    nodeEl.className = 'tree-node-wrapper';
    nodeEl.dataset.id = node.id;
    nodeEl.dataset.search = `${node.component.toLowerCase()} ${node.description.toLowerCase()}`;

    // Inner Content structure
    const content = document.createElement('div');
    content.className = 'tree-node';
    content.onclick = (e) => {
        e.stopPropagation();
        selectNode(node.id);
        toggleCollapse(wrapper);
    };

    // Icon (Folder or Box)
    const icon = document.createElement('div');
    icon.className = 'icon-box text-xs font-bold';
    if (node.children.length > 0) {
        icon.innerHTML = `<svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M4 4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2H4z"/></svg>`;
    } else {
        icon.innerHTML = `<svg class="w-4 h-4 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>`;
    }

    // Text
    const text = document.createElement('div');
    text.className = 'flex flex-col leading-tight';
    text.innerHTML = `
        <span class="font-mono text-sm text-[var(--text-main)] font-semibold node-comp">${node.component}</span>
        <span class="text-[11px] text-[var(--text-muted)] truncate max-w-[180px]">${node.description}</span>
    `;

    // Toggle Arrow (if children)
    const toggle = document.createElement('div');
    toggle.className = 'ml-auto pl-2 text-[var(--text-muted)] transition-transform duration-200 transform';
    if (node.children.length > 0) {
        toggle.innerHTML = `<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`;
        wrapper.classList.add('has-children');
        wrapper.dataset.expanded = 'true'; // Default expanded
    }

    content.appendChild(icon);
    content.appendChild(text);
    if(node.children.length > 0) content.appendChild(toggle);
    
    nodeEl.appendChild(content);
    wrapper.appendChild(nodeEl);

    // Children Container
    if (node.children.length > 0) {
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'tree-children pl-4'; // Indent handled by CSS guides
        node.children.forEach(child => {
            childrenContainer.appendChild(createTreeNode(child));
        });
        wrapper.appendChild(childrenContainer);
    }

    return wrapper;
}

// --- Interaction ---
function selectNode(id) {
    // Remove previous active
    document.querySelectorAll('.tree-node.active').forEach(el => el.classList.remove('active'));
    
    // Add active class
    const nodeEl = document.querySelector(`.tree-node-wrapper[data-id="${id}"] > .tree-node`);
    if(nodeEl) nodeEl.classList.add('active');

    selectedNodeId = id;
    const data = flatMap.get(id);
    updateDetails(data);
}

function toggleCollapse(wrapper) {
    if (!wrapper.classList.contains('has-children')) return;
    
    const children = wrapper.querySelector('.tree-children');
    const toggle = wrapper.querySelector('.tree-node svg.w-3'); // arrow
    
    if (wrapper.dataset.expanded === 'true') {
        children.style.display = 'none';
        wrapper.dataset.expanded = 'false';
        if(toggle) toggle.parentElement.style.transform = 'rotate(-90deg)';
    } else {
        children.style.display = 'block';
        wrapper.dataset.expanded = 'true';
        if(toggle) toggle.parentElement.style.transform = 'rotate(0deg)';
    }
}

function updateDetails(data) {
    document.getElementById('emptyDetails').classList.add('hidden');
    document.getElementById('contentDetails').classList.remove('hidden');

    // Breadcrumbs
    const crumbs = document.getElementById('breadcrumbs');
    crumbs.innerHTML = data.path.map((p, i) => 
        `<span class="${i === data.path.length-1 ? 'text-white font-bold' : 'text-[var(--text-muted)]'}">${p}</span>`
    ).join('<span class="mx-2 text-[var(--border)]">/</span>');

    // Basic Info
    document.getElementById('detailName').textContent = data.component;
    document.getElementById('detailDesc').textContent = data.description || 'No description available';
    document.getElementById('detailLevel').textContent = `Level ${data.level}`;
    
    // Badges
    const badge = document.getElementById('detailBadge');
    if (data.children.length > 0) {
        badge.textContent = 'Assembly';
        badge.className = 'px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-yellow-500/20 text-yellow-400';
    } else {
        badge.textContent = 'Part';
        badge.className = 'px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-blue-500/20 text-blue-400';
    }

    // Stats
    document.getElementById('detailQty').textContent = data.qty;
    document.getElementById('detailExtQty').textContent = data.extendedQty;
    document.getElementById('detailUom').textContent = data.uom;

    // Props Table
    const tbody = document.getElementById('detailTable');
    tbody.innerHTML = `
        <tr class="group hover:bg-[var(--bg-hover)] transition-colors"><td class="p-3 text-[var(--text-muted)] w-1/3">Component ID</td><td class="p-3 text-white font-mono select-all">${data.component}</td></tr>
        <tr class="group hover:bg-[var(--bg-hover)] transition-colors"><td class="p-3 text-[var(--text-muted)]">Description</td><td class="p-3 text-white">${data.description}</td></tr>
        <tr class="group hover:bg-[var(--bg-hover)] transition-colors"><td class="p-3 text-[var(--text-muted)]">Unit of Measure</td><td class="p-3 text-white">${data.uom}</td></tr>
        <tr class="group hover:bg-[var(--bg-hover)] transition-colors"><td class="p-3 text-[var(--text-muted)]">Tree Level</td><td class="p-3 text-white">${data.level}</td></tr>
        <tr class="group hover:bg-[var(--bg-hover)] transition-colors"><td class="p-3 text-[var(--text-muted)]">Child Count</td><td class="p-3 text-white">${data.children.length}</td></tr>
    `;
    
    // Children List (if assembly)
    const childrenSection = document.getElementById('childrenSection');
    const childrenList = document.getElementById('childrenList');
    if (data.children.length > 0) {
        childrenSection.classList.remove('hidden');
        childrenList.innerHTML = data.children.map(c => 
            `<button onclick="selectNode('${c.id}')" class="px-2 py-1 bg-[var(--bg-panel)] border border-[var(--border)] rounded text-xs text-[var(--text-muted)] hover:text-white hover:border-[var(--accent)] transition-colors">${c.component}</button>`
        ).join('');
    } else {
        childrenSection.classList.add('hidden');
    }
}

function updateStats() {
    const total = rawData.length;
    const assemblies = rawData.filter(i => i.children.length > 0).length;
    document.getElementById('treeStats').textContent = `${total} Items • ${assemblies} Assemblies • ${total - assemblies} Parts`;
}

function expandAll() {
    document.querySelectorAll('.tree-branch.has-children').forEach(el => {
        el.dataset.expanded = 'true';
        el.querySelector('.tree-children').style.display = 'block';
        const toggle = el.querySelector('.tree-node svg.w-3');
        if(toggle) toggle.parentElement.style.transform = 'rotate(0deg)';
    });
}

function collapseAll() {
    document.querySelectorAll('.tree-branch.has-children').forEach(el => {
        el.dataset.expanded = 'false';
        el.querySelector('.tree-children').style.display = 'none';
        const toggle = el.querySelector('.tree-node svg.w-3');
        if(toggle) toggle.parentElement.style.transform = 'rotate(-90deg)';
    });
}

// --- Search / Filter ---
document.getElementById('searchInput').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase().trim();
    const wrappers = document.querySelectorAll('.tree-branch');
    const nodes = document.querySelectorAll('.tree-node-wrapper');

    if (!term) {
        // Reset
        wrappers.forEach(w => w.classList.remove('hidden-node'));
        document.querySelectorAll('.node-comp').forEach(el => {
            el.innerHTML = el.textContent; // remove highlight
        });
        return;
    }

    // Pass 1: Mark matching nodes
    const matches = new Set();
    nodes.forEach(n => {
        if (n.dataset.search.includes(term)) {
            matches.add(n.dataset.id);
            // Highlight text
            const compSpan = n.querySelector('.node-comp');
            const original = flatMap.get(n.dataset.id).component;
            const regex = new RegExp(`(${term})`, 'gi');
            compSpan.innerHTML = original.replace(regex, '<span class="text-white bg-[var(--accent)]/50">$1</span>');
        } else {
            const compSpan = n.querySelector('.node-comp');
            compSpan.innerHTML = flatMap.get(n.dataset.id).component;
        }
    });

    // Pass 2: Determine visibility (Match OR Parent of Match OR Child of Match)
    wrappers.forEach(w => {
        // Naive visibility check: hide everything first
        w.classList.add('hidden-node');
    });

    // Walk up from matches to show parents
    matches.forEach(id => {
        let curr = flatMap.get(id);
        
        // Show self and children
        const selfWrapper = document.querySelector(`.tree-node-wrapper[data-id="${id}"]`).parentElement;
        selfWrapper.classList.remove('hidden-node');
        
        // Ensure children are visible
        // (Simplified: we just ensure the direct wrapper is shown, default expands help)
        
        // Walk parents
        while(curr) {
            const nodeEl = document.querySelector(`.tree-node-wrapper[data-id="${curr.id}"]`);
            if (nodeEl) {
                const w = nodeEl.parentElement;
                w.classList.remove('hidden-node');
                
                // Expand parent if it has children
                if (w.classList.contains('has-children')) {
                   w.dataset.expanded = 'true';
                   w.querySelector('.tree-children').style.display = 'block';
                }
            }
            curr = curr.parent;
        }
    });
});

// --- Export ---
function exportJSON() {
    if (treeStructure.length === 0) return alert("No data to export");
    
    // Clean circular references for stringify
    const clean = (nodes) => {
        return nodes.map(n => ({
            level: n.level,
            component: n.component,
            description: n.description,
            qty: n.qty,
            uom: n.uom,
            children: clean(n.children)
        }));
    };
    
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(clean(treeStructure), null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "bom_export.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

function copyDetailJSON() {
    if (!selectedNodeId) return;
    const n = flatMap.get(selectedNodeId);
    const obj = {
        component: n.component,
        description: n.description,
        qty: n.qty,
        extendedQty: n.extendedQty,
        level: n.level
    };
    navigator.clipboard.writeText(JSON.stringify(obj, null, 2));
    const btn = document.querySelector('#contentDetails button');
    const oldText = btn.textContent;
    btn.textContent = "Copied!";
    btn.classList.add('text-[var(--accent)]', 'border-[var(--accent)]');
    setTimeout(() => {
        btn.textContent = oldText;
        btn.classList.remove('text-[var(--accent)]', 'border-[var(--accent)]');
    }, 1500);
}

</script>
</body>
</html>
