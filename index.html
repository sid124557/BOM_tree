<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOM Editor Pro</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Syne:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#07090f; --panel:#0d1117; --card:#111822; --hover:#161f2e;
  --fg:#e2eaf5; --fg2:#8a9ab8; --fg3:#3d4f68;
  --accent:#00c896; --accent-bg:rgba(0,200,150,.1); --accent-bd:rgba(0,200,150,.3);
  --glow:0 14px 32px rgba(0,0,0,.35);
  --bd:rgba(255,255,255,.06); --bd2:rgba(255,255,255,.1);
  --l1:#00c896; --l1b:rgba(0,200,150,.14);
  --l2:#3b82f6; --l2b:rgba(59,130,246,.14);
  --l3:#a78bfa; --l3b:rgba(167,139,250,.14);
  --l4:#f59e0b; --l4b:rgba(245,158,11,.14);
  --l5:#ec4899; --l5b:rgba(236,72,153,.14);
  --l6:#64748b; --l6b:rgba(100,116,139,.14);
  --d-shared:#1e2a3a; --d-shared-fg:#8a9ab8;
  --d-a:#2a1520; --d-a-bd:rgba(239,68,68,.3); --d-a-fg:#ef4444;
  --d-b:#102a1e; --d-b-bd:rgba(34,197,94,.3); --d-b-fg:#22c55e;
  --d-qty:#2a2010; --d-qty-bd:rgba(245,158,11,.3); --d-qty-fg:#f59e0b;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}

/* ── EDIT MODE ── */
.edit-mode-active{position:relative;}
.edit-mode-active::before{content:'';position:absolute;inset:0;border:2px solid var(--accent);border-radius:12px;pointer-events:none;animation:editPulse 2s ease-in-out infinite;}
@keyframes editPulse{0%,100%{opacity:.3;}50%{opacity:.6;}}

/* ── EDIT PANEL ── */
.edit-panel{flex:1;overflow-y:auto;padding:18px 26px;display:none;flex-direction:column;gap:16px;}
.edit-panel.visible{display:flex;}

.edit-controls-bar{display:flex;align-items:center;gap:14px;background:var(--card);border:1px solid var(--bd2);border-radius:10px;padding:14px 18px;flex-wrap:wrap;}
.edit-selector{flex:1;min-width:280px;}
.edit-label{font-size:9px;font-weight:700;color:var(--fg3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;display:block;}
.edit-select{width:100%;background:rgba(0,0,0,.5);border:1px solid var(--bd2);border-radius:6px;color:var(--fg);font-family:'IBM Plex Mono',monospace;font-size:12px;padding:8px 12px;cursor:pointer;transition:border-color .2s;}
.edit-select:focus{outline:none;border-color:var(--accent-bd);box-shadow:0 0 0 3px var(--accent-bg);}

.edit-mode-toggle{display:flex;gap:6px;background:rgba(0,0,0,.3);padding:4px;border-radius:7px;}
.edit-mode-btn{display:inline-flex;align-items:center;gap:6px;padding:7px 13px;border-radius:5px;background:transparent;border:none;color:var(--fg3);font-family:'Syne',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;}
.edit-mode-btn:hover{color:var(--fg2);}
.edit-mode-btn.active{background:var(--accent);color:#000;}
.edit-mode-btn svg{opacity:.7;}
.edit-mode-btn.active svg{opacity:1;}

.edit-actions-bar{display:flex;gap:6px;flex-wrap:wrap;}
.edit-helper{display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(0,200,150,.06);border:1px solid var(--accent-bd);border-radius:8px;font-size:11px;color:var(--fg2);}
.edit-helper strong{color:var(--accent);font-weight:700;}
.edit-indent-controls{display:flex;align-items:center;gap:4px;}
.edit-indent-btn{width:24px;height:24px;border:1px solid var(--bd2);border-radius:4px;background:rgba(255,255,255,.04);color:var(--fg2);font-size:13px;font-weight:700;cursor:pointer;line-height:1;transition:all .15s;}
.edit-indent-btn:hover{background:var(--accent-bg);color:var(--accent);border-color:var(--accent-bd);}
.edit-indent-input{width:52px;text-align:center;}
.edit-level-chip{font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:700;color:var(--fg3);background:rgba(255,255,255,.05);border:1px solid var(--bd);border-radius:4px;padding:4px 6px;text-align:center;}
.edit-action-btn{display:inline-flex;align-items:center;gap:6px;padding:7px 13px;border-radius:6px;background:rgba(255,255,255,.05);border:1px solid var(--bd2);color:var(--fg2);font-family:'Syne',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;white-space:nowrap;}
.edit-action-btn:hover{background:rgba(255,255,255,.09);color:var(--fg);transform:translateY(-1px);}
.edit-action-btn.primary{background:var(--accent);color:#000;border-color:var(--accent);}
.edit-action-btn.primary:hover{background:#00dfb8;box-shadow:0 4px 14px rgba(0,200,150,.35);}

.edit-table-container{flex:1;background:var(--card);border:1px solid var(--bd2);border-radius:10px;overflow:hidden;min-height:400px;display:flex;flex-direction:column;}
.edit-table-header{display:grid;grid-template-columns:24px 48px 60px 1fr 1.5fr 80px 60px 100px;gap:8px;padding:10px 16px;background:rgba(0,0,0,.4);border-bottom:1px solid var(--bd);position:sticky;top:0;z-index:2;}
.edit-table-header span{font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:700;color:var(--fg3);text-transform:uppercase;letter-spacing:.1em;}
.edit-table-body{flex:1;overflow-y:auto;}

.edit-row{display:grid;grid-template-columns:24px 48px 60px 1fr 1.5fr 80px 60px 100px;gap:8px;padding:10px 16px;border-bottom:1px solid var(--bd);align-items:center;transition:background .15s;}
.edit-row:hover{background:var(--hover);}
.edit-row.selected{background:rgba(0,200,150,.08);outline:1px solid var(--accent-bd);outline-offset:-1px;}
.edit-row.selected .edit-level-badge{box-shadow:0 0 0 1px var(--accent-bd) inset;}

.edit-row:last-child{border-bottom:none;}
.edit-row.dragging{opacity:.4;}
.edit-row.drag-over{border-top:2px solid var(--accent);margin-top:-2px;}

.edit-drag-handle{cursor:move;display:grid;place-items:center;color:var(--fg3);opacity:.3;transition:opacity .2s;}
.edit-row:hover .edit-drag-handle{opacity:1;}
.edit-drag-handle:hover{color:var(--accent);}

.edit-level-badge{font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:700;padding:3px 7px;border-radius:4px;text-align:center;}
.edit-level-badge.l1{background:var(--l1b);color:var(--l1);}
.edit-level-badge.l2{background:var(--l2b);color:var(--l2);}
.edit-level-badge.l3{background:var(--l3b);color:var(--l3);}
.edit-level-badge.l4{background:var(--l4b);color:var(--l4);}
.edit-level-badge.l5{background:var(--l5b);color:var(--l5);}
.edit-level-badge.l6{background:var(--l6b);color:var(--l6);}

.edit-input{background:rgba(0,0,0,.5);border:1px solid var(--bd2);border-radius:5px;color:var(--fg);font-family:'IBM Plex Mono',monospace;font-size:11px;padding:6px 8px;width:100%;transition:all .2s;}
.edit-input:focus{outline:none;border-color:var(--accent);background:rgba(0,0,0,.7);box-shadow:0 0 0 2px var(--accent-bg);}
.edit-input.qty{text-align:right;}
.edit-input:disabled{background:rgba(0,0,0,.2);border-color:rgba(255,255,255,.03);color:var(--fg3);cursor:not-allowed;}

.edit-text{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--fg2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.edit-text.code{font-weight:600;color:var(--fg);}

.edit-row-actions{display:flex;gap:4px;opacity:0;transition:opacity .2s;}
.edit-row:hover .edit-row-actions{opacity:1;}
.edit-icon-btn{width:24px;height:24px;display:grid;place-items:center;background:rgba(255,255,255,.04);border:1px solid var(--bd2);border-radius:4px;color:var(--fg3);cursor:pointer;transition:all .15s;}
.edit-icon-btn:hover{background:var(--accent-bg);color:var(--accent);border-color:var(--accent-bd);}
.edit-icon-btn.del:hover{background:rgba(239,68,68,.12);color:#ef4444;border-color:rgba(239,68,68,.25);}
.edit-icon-btn.dup:hover{background:rgba(34,197,94,.12);color:#22c55e;border-color:rgba(34,197,94,.25);}
.edit-icon-btn.add:hover{background:rgba(59,130,246,.14);color:#60a5fa;border-color:rgba(59,130,246,.3);}

.edit-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 24px;gap:12px;color:var(--fg3);text-align:center;}

.edit-mode .part-row{background:rgba(0,200,150,.015);}
.edit-mode .part-row:hover{background:rgba(0,200,150,.05);}
.edit-field{background:rgba(0,0,0,.5);border:1px solid var(--bd2);border-radius:4px;color:var(--fg);font-family:inherit;font-size:inherit;padding:3px 6px;width:100%;transition:border-color .2s,background .2s;}
.edit-field:focus{outline:none;border-color:var(--accent);background:rgba(0,0,0,.7);box-shadow:0 0 0 2px var(--accent-bg);}
.edit-field.qty{text-align:right;}
.edit-actions{display:none;gap:3px;}
.edit-mode .edit-actions{display:flex;}
.part-row:hover .edit-actions{opacity:1;}
.edit-btn{width:22px;height:22px;display:grid;place-items:center;background:rgba(255,255,255,.04);border:1px solid var(--bd2);border-radius:4px;color:var(--fg3);cursor:pointer;transition:all .15s;flex-shrink:0;}
.edit-btn:hover{background:var(--accent-bg);color:var(--accent);border-color:var(--accent-bd);}
.edit-btn.del:hover{background:rgba(239,68,68,.12);color:#ef4444;border-color:rgba(239,68,68,.25);}
.edit-btn.add:hover{background:rgba(34,197,94,.12);color:#22c55e;border-color:rgba(34,197,94,.25);}
.drag-handle{cursor:move;opacity:.2;transition:opacity .2s;display:none;}
.edit-mode .drag-handle{display:grid;}
.part-row:hover .drag-handle{opacity:.7;}
.drag-handle:hover{opacity:1!important;color:var(--accent);}
.part-wrap.dragging{opacity:.4;transform:scale(.98);}
.part-wrap.drag-over-top{border-top:2px solid var(--accent);margin-top:-2px;}
.part-wrap.drag-over-bottom{border-bottom:2px solid var(--accent);margin-bottom:-2px;}
.add-row-zone{padding:8px 15px;border-top:1px dashed var(--bd2);background:rgba(0,200,150,.015);display:none;align-items:center;justify-content:center;gap:6px;}
.edit-mode .add-row-zone{display:flex;}
.add-row-btn{display:inline-flex;align-items:center;gap:5px;padding:5px 10px;border-radius:5px;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.25);color:#22c55e;font-size:10px;font-weight:700;cursor:pointer;transition:all .15s;}
.add-row-btn:hover{background:rgba(34,197,94,.18);transform:translateY(-1px);}
.export-menu{position:relative;}
.export-dropdown{position:absolute;top:calc(100% + 6px);right:0;background:var(--card);border:1px solid var(--bd2);border-radius:8px;padding:4px;min-width:180px;display:none;flex-direction:column;gap:2px;box-shadow:0 8px 32px rgba(0,0,0,.5);z-index:100;}
.export-dropdown.show{display:flex;}
.export-opt{display:flex;align-items:center;gap:8px;padding:8px 11px;border-radius:5px;color:var(--fg2);font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;white-space:nowrap;}
.export-opt:hover{background:var(--hover);color:var(--fg);}
.export-opt svg{opacity:.7;flex-shrink:0;}
.mode-toggle{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:6px;background:rgba(255,255,255,.04);border:1px solid var(--bd2);color:var(--fg2);font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;}
.mode-toggle:hover{background:rgba(255,255,255,.08);color:var(--fg);}
.mode-toggle.active{background:var(--accent-bg);border-color:var(--accent-bd);color:var(--accent);}

/* ── TAB BAR ── */
.tab-bar{display:flex;gap:0;border-bottom:1px solid var(--bd);flex-shrink:0;background:var(--panel);}
.tab-btn{display:flex;align-items:center;gap:6px;padding:11px 18px;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;color:var(--fg3);cursor:pointer;border:none;background:transparent;border-bottom:2px solid transparent;transition:all .15s;letter-spacing:.01em;}
.tab-btn:hover{color:var(--fg2);}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab-btn svg{opacity:.7;}
.tab-btn.active svg{opacity:1;}

/* ── DIFF PANEL ── */
.diff-panel{flex:1;overflow-y:auto;padding:18px 26px;display:none;flex-direction:column;gap:14px;}
.diff-panel.visible{display:flex;}
.diff-selectors{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;background:var(--card);border:1px solid var(--bd2);border-radius:9px;padding:14px 16px;}
.diff-sel-side{display:flex;flex-direction:column;gap:6px;}
.diff-sel-label{font-size:9px;font-weight:700;color:var(--fg3);text-transform:uppercase;letter-spacing:.1em;}
.diff-sel-inner{display:flex;align-items:center;gap:8px;}
.diff-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
select.diff-select{flex:1;background:rgba(0,0,0,.5);border:1px solid var(--bd2);border-radius:6px;color:var(--fg);font-family:'IBM Plex Mono',monospace;font-size:11px;padding:7px 10px;cursor:pointer;transition:border-color .2s;}
select.diff-select:focus{outline:none;border-color:var(--accent-bd);}
.diff-vs{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:700;color:var(--fg3);text-align:center;padding:6px;}
.diff-run-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;border-radius:6px;background:var(--accent);color:#000;font-family:'Syne',sans-serif;font-weight:700;font-size:12px;cursor:pointer;border:none;transition:all .15s;white-space:nowrap;}
.diff-run-btn:hover{background:#00dfb8;transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,200,150,.35);}
.diff-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
.diff-card{border-radius:8px;padding:12px 14px;border:1px solid;}
.diff-card.shared{background:rgba(30,42,58,.5);border-color:rgba(138,154,184,.2);}
.diff-card.only-a{background:rgba(42,21,32,.6);border-color:var(--d-a-bd);}
.diff-card.only-b{background:rgba(16,42,30,.6);border-color:var(--d-b-bd);}
.diff-card.qty-diff{background:rgba(42,32,16,.6);border-color:var(--d-qty-bd);}
.diff-card-n{font-family:'IBM Plex Mono',monospace;font-size:22px;font-weight:700;line-height:1;}
.diff-card.shared .diff-card-n{color:var(--d-shared-fg);}
.diff-card.only-a .diff-card-n{color:var(--d-a-fg);}
.diff-card.only-b .diff-card-n{color:var(--d-b-fg);}
.diff-card.qty-diff .diff-card-n{color:var(--d-qty-fg);}
.diff-card-label{font-size:10px;font-weight:600;color:var(--fg3);margin-top:4px;text-transform:uppercase;letter-spacing:.07em;}
.diff-card-sub{font-size:9px;color:var(--fg3);margin-top:2px;font-family:'IBM Plex Mono',monospace;}
.diff-table-wrap{background:var(--card);border:1px solid var(--bd2);border-radius:9px;overflow:hidden;}
.compare-split{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:start;}
.compare-pane{border:1px solid var(--bd2);border-radius:9px;background:var(--card);overflow:hidden;}
.compare-pane-head{padding:8px 11px;background:rgba(0,0,0,.35);border-bottom:1px solid var(--bd);font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:700;}
.cmp-row{display:grid;grid-template-columns:62px 1fr 64px 64px 1fr;gap:6px;padding:7px 10px;border-bottom:1px solid var(--bd);font-size:10px;align-items:center;}
.cmp-row:last-child{border-bottom:none;}
.cmp-status{font-weight:700;font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:.06em;padding:2px 4px;border-radius:3px;text-transform:uppercase;text-align:center;}
.cmp-code{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cmp-qty,.cmp-sup{font-family:'IBM Plex Mono',monospace;text-align:right;}
.cmp-desc{color:var(--fg2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cmp-add{background:rgba(34,197,94,.12);} .cmp-add .cmp-status{background:rgba(34,197,94,.16);color:#22c55e;}
.cmp-del{background:rgba(239,68,68,.12);} .cmp-del .cmp-status{background:rgba(239,68,68,.16);color:#ef4444;}
.cmp-mod{background:rgba(245,158,11,.12);} .cmp-mod .cmp-status{background:rgba(245,158,11,.16);color:#f59e0b;}
.cmp-same{background:rgba(138,154,184,.08);} .cmp-same .cmp-status{background:rgba(138,154,184,.14);color:#8a9ab8;}
.diff-table-head{display:grid;grid-template-columns:56px 1fr 1fr;gap:0;background:rgba(0,0,0,.4);border-bottom:1px solid var(--bd);}
.diff-table-head > div{padding:8px 14px;font-size:9px;font-weight:700;color:var(--fg3);text-transform:uppercase;letter-spacing:.1em;font-family:'IBM Plex Mono',monospace;}
.diff-table-head > div:not(:last-child){border-right:1px solid var(--bd);}
.diff-row{display:grid;grid-template-columns:56px 1fr 1fr;gap:0;border-bottom:1px solid var(--bd);transition:filter .1s;}
.diff-row:last-child{border-bottom:none;}
.diff-row:hover{filter:brightness(1.15);}
.diff-row.shared{background:var(--d-shared);}
.diff-row.only-a{background:var(--d-a);}
.diff-row.only-b{background:var(--d-b);}
.diff-row.qty-diff{background:var(--d-qty);}
.diff-tag{display:flex;align-items:center;justify-content:center;padding:8px 6px;border-right:1px solid var(--bd);}
.diff-tag span{font-family:'IBM Plex Mono',monospace;font-size:8px;font-weight:700;padding:2px 5px;border-radius:3px;text-transform:uppercase;letter-spacing:.06em;}
.diff-row.shared .diff-tag span{background:rgba(138,154,184,.12);color:var(--d-shared-fg);}
.diff-row.only-a .diff-tag span{background:rgba(239,68,68,.15);color:var(--d-a-fg);}
.diff-row.only-b .diff-tag span{background:rgba(34,197,94,.15);color:var(--d-b-fg);}
.diff-row.qty-diff .diff-tag span{background:rgba(245,158,11,.15);color:var(--d-qty-fg);}
.diff-cell{padding:8px 14px;border-right:1px solid var(--bd);display:flex;flex-direction:column;gap:2px;min-width:0;}
.diff-cell:last-child{border-right:none;}
.diff-cell-code{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.diff-cell-desc{font-size:10px;color:var(--fg2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.diff-cell-qty{font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:600;margin-top:2px;}
.diff-row.shared .diff-cell-qty{color:var(--d-shared-fg);}
.diff-row.only-a .diff-cell-qty{color:var(--d-a-fg);}
.diff-row.only-b .diff-cell-qty{color:var(--d-b-fg);}
.diff-row.qty-diff .diff-cell-qty{color:var(--d-qty-fg);}
.diff-cell-empty{color:var(--fg3);font-style:italic;font-size:10px;align-self:center;}
.diff-filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.diff-filter-label{font-size:10px;color:var(--fg3);font-weight:600;}
.diff-chip{display:inline-flex;align-items:center;gap:5px;padding:5px 10px;border-radius:20px;border:1px solid;font-family:'Syne',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;user-select:none;}
.diff-chip.shared{border-color:rgba(138,154,184,.3);color:var(--d-shared-fg);background:transparent;}
.diff-chip.shared.on{background:rgba(30,42,58,.8);}
.diff-chip.only-a{border-color:var(--d-a-bd);color:var(--d-a-fg);background:transparent;}
.diff-chip.only-a.on{background:rgba(42,21,32,.8);}
.diff-chip.only-b{border-color:var(--d-b-bd);color:var(--d-b-fg);background:transparent;}
.diff-chip.only-b.on{background:rgba(16,42,30,.8);}
.diff-chip.qty-diff{border-color:var(--d-qty-bd);color:var(--d-qty-fg);background:transparent;}
.diff-chip.qty-diff.on{background:rgba(42,32,16,.8);}
.diff-chip-dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
.dlv{font-family:'IBM Plex Mono',monospace;font-size:8px;font-weight:700;padding:1px 4px;border-radius:3px;background:rgba(255,255,255,.08);color:var(--fg3);margin-left:4px;flex-shrink:0;}
.diff-empty{text-align:center;padding:48px 20px;color:var(--fg3);font-size:12px;}
.diff-export{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:5px;background:rgba(255,255,255,.05);border:1px solid var(--bd2);color:var(--fg2);font-family:'Syne',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;margin-left:auto;}
.diff-export:hover{background:rgba(255,255,255,.09);color:var(--fg);}

body{font-family:'Syne',sans-serif;background:radial-gradient(circle at top left,#0f1727 0%,#07090f 42%,#05070d 100%);color:var(--fg);min-height:100vh;display:grid;grid-template-columns:320px 1fr;height:100vh;overflow:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,200,150,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,200,150,.025) 1px,transparent 1px);background-size:36px 36px;pointer-events:none;z-index:0;}
body::after{content:'';position:fixed;inset:0;background:radial-gradient(550px 320px at 10% -5%,rgba(59,130,246,.14),transparent 70%),radial-gradient(460px 280px at 90% -15%,rgba(0,200,150,.1),transparent 70%);pointer-events:none;z-index:0;}

.sidebar{position:relative;z-index:1;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0)),var(--panel);border-right:1px solid var(--bd2);display:flex;flex-direction:column;overflow:hidden;backdrop-filter:blur(6px);}
.sb-head{padding:20px 20px 14px;border-bottom:1px solid var(--bd);flex-shrink:0;}
.logo{display:flex;align-items:center;gap:9px;margin-bottom:4px;}
.logo-box{width:28px;height:28px;background:var(--accent);border-radius:5px;display:grid;place-items:center;flex-shrink:0;}
.logo-box svg{color:#000;}
h1{font-size:17px;font-weight:800;letter-spacing:-.02em;}
h1 span{color:var(--accent);}
.sb-sub{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--fg3);letter-spacing:.06em;text-transform:uppercase;}

.sb-input{padding:14px 16px;border-bottom:1px solid var(--bd);flex-shrink:0;background:rgba(255,255,255,.01);}
.meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;}
.meta-grid input{background:rgba(0,0,0,.35);border:1px solid var(--bd2);border-radius:6px;color:var(--fg);padding:7px 8px;font-size:11px;font-family:'IBM Plex Mono',monospace;}
.meta-grid input:focus{outline:none;border-color:var(--accent-bd);}
.inp-label{font-size:9px;font-weight:700;color:var(--fg3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;}
.mono-tag{font-family:'IBM Plex Mono',monospace;font-size:8px;background:rgba(255,255,255,.05);padding:2px 5px;border-radius:3px;}
textarea{width:100%;min-height:110px;background:rgba(0,0,0,.4);border:1px solid var(--bd2);border-radius:7px;color:var(--fg);font-family:'IBM Plex Mono',monospace;font-size:10px;line-height:1.6;padding:9px 11px;resize:vertical;transition:border-color .2s,box-shadow .2s;}
textarea:focus{outline:none;border-color:var(--accent-bd);box-shadow:0 0 0 3px var(--accent-bg);}
textarea::placeholder{color:var(--fg3);}
.btn-row{display:flex;gap:6px;margin-top:9px;}
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 12px;border-radius:7px;font-family:'Syne',sans-serif;font-weight:700;font-size:11px;cursor:pointer;transition:all .15s;border:none;white-space:nowrap;}
.btn-p{background:var(--accent);color:#000;flex:1;}
.btn-p:hover{background:#00dfb8;transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,200,150,.35);}
.btn-g{background:rgba(255,255,255,.05);color:var(--fg2);border:1px solid var(--bd2);}
.btn-g:hover{background:rgba(255,255,255,.09);color:var(--fg);}
.quick-add{background:rgba(255,255,255,.02);border:1px solid var(--bd2);border-radius:8px;padding:8px;display:flex;flex-direction:column;gap:6px;margin-top:8px;}
.quick-add textarea{min-height:70px;max-height:110px;}
.quick-add small{font-size:9px;color:var(--fg3);line-height:1.4;}

.bom-library{padding:10px 14px;border-bottom:1px solid var(--bd);max-height:170px;overflow:auto;}
.bom-lib-item{display:flex;gap:8px;align-items:center;padding:7px 8px;border:1px solid var(--bd);border-radius:7px;margin-bottom:6px;background:rgba(255,255,255,.02);}
.bom-lib-item button{border:none;background:rgba(255,255,255,.06);color:var(--fg2);font-size:10px;border-radius:4px;padding:4px 7px;cursor:pointer;}
.bom-lib-item button:hover{background:rgba(255,255,255,.12);color:var(--fg);}

.bulk-edit{padding:10px 14px;border-bottom:1px solid var(--bd);display:flex;flex-direction:column;gap:6px;}
.bulk-edit select,.bulk-edit input{background:rgba(0,0,0,.35);border:1px solid var(--bd2);border-radius:6px;color:var(--fg);padding:7px 8px;font-size:11px;font-family:'IBM Plex Mono',monospace;}
.bulk-edit .btn-row{margin-top:2px;}

.sb-nav{flex:1;overflow-y:auto;padding:10px 12px;}
.nav-title{font-size:9px;font-weight:700;color:var(--fg3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;padding:0 4px;}
.nav-empty{text-align:center;padding:24px 10px;color:var(--fg3);font-size:11px;}
.nav-item{display:flex;align-items:center;gap:8px;padding:8px 9px;border-radius:7px;cursor:pointer;transition:all .15s;margin-bottom:2px;border:1px solid transparent;}
.nav-item:hover{background:var(--hover);}
.nav-item.active{background:var(--accent-bg);border-color:var(--accent-bd);}
.nav-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.nav-info{flex:1;min-width:0;}
.nav-code{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.nav-desc{font-size:10px;color:var(--fg2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;}
.nav-badge{font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;flex-shrink:0;}

.sb-stats{border-top:1px solid var(--bd);display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--bd);flex-shrink:0;}
.stat-cell{background:var(--panel);padding:9px 5px;text-align:center;}
.stat-n{font-family:'IBM Plex Mono',monospace;font-size:18px;font-weight:600;color:var(--accent);line-height:1;}
.stat-k{font-size:8px;color:var(--fg3);text-transform:uppercase;letter-spacing:.07em;margin-top:2px;}

.main{position:relative;z-index:1;display:flex;flex-direction:column;overflow:hidden;}
.main-hdr{padding:18px 26px 12px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;flex-shrink:0;backdrop-filter:blur(8px);background:linear-gradient(180deg,rgba(17,24,34,.9),rgba(17,24,34,.68));}
.main-title-wrap{flex:1;min-width:0;}
.main-eyebrow{font-size:9px;font-weight:700;color:var(--fg3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:3px;}
.main-asm-name{font-size:19px;font-weight:800;letter-spacing:-.02em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.main-asm-code{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--fg2);margin-top:2px;}
.ctrls{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.sw{position:relative;}
.sw svg{position:absolute;left:8px;top:50%;transform:translateY(-50%);color:var(--fg3);pointer-events:none;}
.search{background:rgba(0,0,0,.4);border:1px solid var(--bd2);border-radius:999px;padding:7px 12px 7px 28px;color:var(--fg);font-family:'IBM Plex Mono',monospace;font-size:11px;width:190px;transition:all .2s;}
.search:focus{outline:none;border-color:var(--accent-bd);box-shadow:0 0 0 3px var(--accent-bg);width:230px;}
.ic-btn{width:30px;height:30px;display:grid;place-items:center;background:rgba(255,255,255,.04);border:1px solid var(--bd2);border-radius:8px;color:var(--fg3);cursor:pointer;transition:all .15s;}
.ic-btn:hover{color:var(--fg);background:rgba(255,255,255,.08);}

.tree-area{flex:1;overflow-y:auto;padding:18px 26px;}

.asm-block{margin-bottom:18px;border:1px solid var(--bd2);border-radius:12px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.015),rgba(255,255,255,0)),var(--card);box-shadow:var(--glow);}
.asm-bar{display:flex;align-items:center;gap:11px;padding:12px 15px;cursor:pointer;border-bottom:1px solid var(--bd);transition:background .15s;user-select:none;}
.asm-bar:hover{background:var(--hover);}
.asm-accent{width:3px;height:32px;border-radius:2px;flex-shrink:0;}
.asm-bar-info{flex:1;min-width:0;}
.asm-bar-code{font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:600;}
.asm-bar-desc{font-size:11px;color:var(--fg2);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.asm-meta{display:flex;align-items:center;gap:7px;flex-shrink:0;}
.asm-cnt{font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:700;padding:3px 8px;border-radius:4px;}
.asm-chev{transition:transform .25s;color:var(--fg3);}

.col-hdr{display:grid;gap:6px;padding:6px 15px;background:rgba(0,0,0,.35);border-bottom:1px solid var(--bd);}
.col-hdr span{font-size:8px;font-weight:700;color:var(--fg3);text-transform:uppercase;letter-spacing:.1em;font-family:'IBM Plex Mono',monospace;}

/* 8-col grid for edit mode: drag | toggle | level | component | description | qty | uom | actions */
.rg{display:grid;grid-template-columns:22px 18px 56px 1fr 1.4fr 76px 48px 80px;gap:6px;align-items:center;}
.rg.view-mode{grid-template-columns:18px 56px 1fr 1.4fr 76px 48px 24px;}

.parts-body{overflow:hidden;max-height:0;transition:max-height .3s cubic-bezier(.4,0,.2,1);}
.parts-body.open{max-height:999999px;}

.part-wrap{border-bottom:1px solid var(--bd);}
.part-wrap:last-child{border-bottom:none;}
.part-row{padding:7px 15px;cursor:pointer;transition:background .12s;user-select:none;}
.part-row:hover{background:linear-gradient(90deg,rgba(0,200,150,.08),transparent 55%),var(--hover);}
.part-row.match{background:rgba(0,200,150,.07);outline:1px solid var(--accent-bd);outline-offset:-1px;}

.ptog{display:grid;place-items:center;color:var(--fg3);}
.ptog svg{transition:transform .2s;}
.ptog.open svg{transform:rotate(90deg);}
.ptog.leaf{opacity:.18;pointer-events:none;}

.lbadge{font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:700;padding:2px 5px;border-radius:3px;text-align:center;}
.lbadge.l1{background:var(--l1b);color:var(--l1);}
.lbadge.l2{background:var(--l2b);color:var(--l2);}
.lbadge.l3{background:var(--l3b);color:var(--l3);}
.lbadge.l4{background:var(--l4b);color:var(--l4);}
.lbadge.l5{background:var(--l5b);color:var(--l5);}
.lbadge.l6{background:var(--l6b);color:var(--l6);}

.pcode{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pdesc{font-size:11px;color:var(--fg2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pqty{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--accent);font-weight:600;text-align:right;}
.puom{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--fg3);text-align:center;}

.copy-btn{opacity:0;width:22px;height:22px;display:grid;place-items:center;background:transparent;border:none;border-radius:3px;color:var(--fg3);cursor:pointer;transition:all .15s;}
.part-row:hover .copy-btn{opacity:1;}
.copy-btn:hover{background:var(--accent-bg);color:var(--accent);}

.child-wrap{overflow:hidden;max-height:0;transition:max-height .28s cubic-bezier(.4,0,.2,1);border-left:2px solid var(--bd2);margin-left:26px;background:rgba(0,0,0,.1);}
.child-wrap.open{max-height:999999px;}

.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:70px 24px;gap:12px;color:var(--fg3);text-align:center;}
.empty-ring{width:52px;height:52px;border:2px dashed rgba(255,255,255,.08);border-radius:12px;display:grid;place-items:center;}
.empty-title{font-size:14px;font-weight:700;color:var(--fg2);}
.empty-desc{font-size:12px;line-height:1.65;max-width:380px;}

.toast{position:fixed;bottom:16px;right:16px;background:var(--card);border:1px solid var(--accent-bd);color:var(--fg);padding:8px 13px;border-radius:8px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:7px;opacity:0;transform:translateY(10px);transition:all .2s;z-index:999;pointer-events:none;box-shadow:var(--glow);}
.toast.on{opacity:1;transform:translateY(0);}

::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.07);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.13);}

@media(max-width:1080px){
  body{grid-template-columns:290px 1fr;}
  .diff-summary{grid-template-columns:repeat(2,minmax(0,1fr));}
  .compare-split{grid-template-columns:1fr;}
}

@media(max-width:860px){
  body{grid-template-columns:1fr;}
  .sidebar{height:auto;}
  .tree-area{padding:14px;}
  .main-hdr{padding:14px;}
  .search{width:150px;}
  .search:focus{width:180px;}
  .rg{grid-template-columns:18px 42px 1fr 1fr 60px 40px 60px;}
  .rg.view-mode{grid-template-columns:18px 42px 1fr 1fr 60px 40px 24px;}
  .diff-selectors{grid-template-columns:1fr;}
  .diff-vs{display:none;}
  .diff-summary{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<aside class="sidebar">
  <div class="sb-head">
    <div class="logo">
      <div class="logo-box">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
          <rect x="3" y="14" width="7" height="7" rx="1"/><line x1="17.5" y1="10.5" x2="17.5" y2="14"/>
          <line x1="14" y1="17.5" x2="17.5" y2="17.5"/><line x1="21" y1="17.5" x2="17.5" y2="17.5"/>
        </svg>
      </div>
      <h1>BOM <span>Editor Pro</span></h1>
    </div>
    <div class="sb-sub">Bill of Materials — Edit & Compare</div>
  </div>

  <div class="sb-input">
    <div class="meta-grid">
      <input id="meta-project" placeholder="Project Name">
      <input id="meta-version" placeholder="Version / Revision">
      <input id="meta-date" type="date">
      <input id="meta-supplier" placeholder="Default Supplier">
    </div>
    <div class="inp-label">
      <span>Paste BOM Data</span>
      <span class="mono-tag">tab-separated</span>
    </div>
    <textarea id="raw" placeholder="Paste SAP BOM export here...&#10;&#10;Expected columns:&#10;Plant | Level | Material | Material Description&#10;| Component | Component Description | Qty | Qty(BUn) | UOM | ..."></textarea>
    <div class="btn-row">
      <button class="btn btn-p" onclick="go()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        Generate
      </button>
      <button class="btn btn-g" onclick="loadSample()">Sample</button>
      <button class="btn btn-g" onclick="clearAll()">Clear</button>
    </div>
    <div class="quick-add">
      <div class="inp-label" style="margin-bottom:0"><span>Rapid Entry</span><span class="mono-tag">part	qty	desc	supplier</span></div>
      <textarea id="quick-add" placeholder="BO1001	2	BRACKET	ABC SUPPLIER"></textarea>
      <div class="btn-row" style="margin-top:0">
        <button class="btn btn-g" onclick="quickAddRows()">Quick-Add</button>
        <button class="btn btn-g" onclick="saveCurrentBom()">Save BOM</button>
      </div>
      <small>Press <strong>Tab</strong> between fields and <strong>Enter</strong> for next row, then Quick-Add.</small>
    </div>
  </div>

  <div class="bom-library">
    <div class="nav-title">BOM Versions</div>
    <div id="bom-library"><div class="nav-empty">No saved BOM versions</div></div>
  </div>

  <div class="bulk-edit">
    <div class="nav-title" style="margin:0">Bulk Actions</div>
    <select id="bulk-target"><option value="">Select loaded assembly</option></select>
    <input id="bulk-supplier" placeholder="Set supplier for all rows">
    <input id="bulk-qty-factor" type="number" step="0.01" min="0" placeholder="Multiply qty (e.g. 1.1)">
    <div class="btn-row"><button class="btn btn-g" onclick="applyBulkEdit()">Apply Bulk Edit</button></div>
  </div>

  <div class="sb-nav">
    <div class="nav-title">Assemblies</div>
    <div id="nav-list"><div class="nav-empty">No data loaded yet</div></div>
  </div>

  <div class="sb-stats" id="sb-stats" style="display:none">
    <div class="stat-cell"><div class="stat-n" id="s-asm">0</div><div class="stat-k">Assemblies</div></div>
    <div class="stat-cell"><div class="stat-n" id="s-rows">0</div><div class="stat-k">Total Rows</div></div>
    <div class="stat-cell"><div class="stat-n" id="s-max">0</div><div class="stat-k">Max Depth</div></div>
  </div>
</aside>

<div class="main">
  <div class="main-hdr">
    <div class="main-title-wrap">
      <div class="main-eyebrow">Viewing</div>
      <div class="main-asm-name" id="hdr-name" style="color:var(--fg3)">No assembly selected</div>
      <div class="main-asm-code" id="hdr-code">Load data to begin</div>
    </div>
    <div class="ctrls">
      <div class="export-menu">
        <button class="ic-btn" title="Export options" onclick="toggleExportMenu()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        </button>
        <div class="export-dropdown" id="export-dropdown">
          <div class="export-opt" onclick="exportCurrentCSV()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
            Export CSV
          </div>
          <div class="export-opt" onclick="exportCurrentExcel()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
            Export TSV (Excel)
          </div>
          <div class="export-opt" onclick="saveAsNewBOM()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Save as New BOM
          </div>
        </div>
      </div>
      <div class="sw">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input class="search" id="search" type="text" placeholder="Search components…" oninput="doSearch(this.value)">
      </div>
      <button class="ic-btn" title="Expand all" onclick="expandAll()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
      </button>
      <button class="ic-btn" title="Collapse all" onclick="collapseAll()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" y1="10" x2="21" y2="3"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
      </button>
    </div>
  </div>

  <div class="tab-bar">
    <button class="tab-btn active" id="tab-tree" onclick="switchTab('tree')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg>
      Tree View
    </button>
    <button class="tab-btn" id="tab-edit" onclick="switchTab('edit')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      Edit
    </button>
    <button class="tab-btn" id="tab-diff" onclick="switchTab('diff')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/><line x1="3" y1="20" x2="21" y2="20"/></svg>
      Diff / Compare
    </button>
  </div>

  <div class="tree-area" id="tree">
    <div class="empty">
      <div class="empty-ring"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg></div>
      <div class="empty-title">No BOM data loaded</div>
      <div class="empty-desc">Paste your SAP BOM export and click Generate.<br><br>Each unique <strong>Material</strong> (col 3) becomes its own collapsible assembly block. The <strong>Level</strong> column (col 2) drives the hierarchy depth.</div>
    </div>
  </div>

  <!-- EDIT VIEW -->
  <div class="edit-panel" id="edit-panel">
    <!-- Edit Controls Bar -->
    <div class="edit-controls-bar">
      <div class="edit-selector">
        <label class="edit-label">Assembly to Edit</label>
        <select class="edit-select" id="edit-asm-select" onchange="selectEditAsm()">
          <option value="">— Select assembly to edit —</option>
        </select>
      </div>
      <div class="edit-mode-toggle">
        <button class="edit-mode-btn" id="view-only-btn" onclick="setEditViewMode('view')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          View Only
        </button>
        <button class="edit-mode-btn active" id="edit-mode-btn" onclick="setEditViewMode('edit')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          Edit Mode
        </button>
      </div>
      <div class="edit-actions-bar">
        <button class="edit-action-btn" onclick="addNewRowEdit()" title="Add new part">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Part
        </button>
        <button class="edit-action-btn" onclick="addChildPartFromSelection()" title="Add part under selected row">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4v6a2 2 0 0 0 2 2h14"/><path d="M14 10h6"/><path d="M17 7v6"/></svg>
          Add Child
        </button>
        <button class="edit-action-btn" onclick="addSiblingPartFromSelection()" title="Add part below selected row">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h10"/><path d="M17 8v8"/><path d="M13 4H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h7"/></svg>
          Add Below
        </button>
        <button class="edit-action-btn" onclick="undoLastChange()" title="Undo last change">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
          Undo
        </button>
        <button class="edit-action-btn" onclick="cloneEditedAssembly()" title="Create a new BOM from this edited assembly">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          New BOM from Edit
        </button>
        <button class="edit-action-btn primary" onclick="saveEditChanges()" title="Save changes">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          Save Changes
        </button>
      </div>
    </div>

    <div class="edit-helper">
      <strong>Tip:</strong> Click a row first, then use <em>Add Child</em>/<em>Add Below</em> for targeted insertion in sub-assemblies. Use <em>Indent</em> controls for quick hierarchy fixes, then <em>New BOM from Edit</em> to clone.
    </div>

    <!-- Edit Table View -->
    <div class="edit-table-container" id="edit-table-container">
      <div class="edit-empty">
        <div class="empty-ring">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
        </div>
        <div class="empty-title">No Assembly Selected</div>
        <div class="empty-desc">Select an assembly from the dropdown above to begin editing</div>
      </div>
    </div>
  </div>

  <!-- DIFF VIEW -->
  <div class="diff-panel" id="diff-panel">
    <div class="diff-selectors">
      <div class="diff-sel-side">
        <div class="diff-sel-label">Assembly A</div>
        <div class="diff-sel-inner">
          <div class="diff-dot" id="dot-a" style="background:#ef4444"></div>
          <select class="diff-select" id="sel-a"><option value="">— Select BOM —</option></select>
        </div>
      </div>
      <div class="diff-vs">VS</div>
      <div class="diff-sel-side">
        <div class="diff-sel-label">Assembly B</div>
        <div class="diff-sel-inner">
          <div class="diff-dot" id="dot-b" style="background:#22c55e"></div>
          <select class="diff-select" id="sel-b"><option value="">— Select BOM —</option></select>
        </div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
      <button class="diff-run-btn" onclick="runDiff()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        Run Comparison
      </button>
      <button class="diff-export" id="diff-export-btn" onclick="exportDiff()" style="display:none">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Download Comparison CSV
      </button>
    </div>
    <div class="diff-summary" id="diff-summary" style="display:none">
      <div class="diff-card shared">
        <div class="diff-card-n" id="dc-shared">0</div>
        <div class="diff-card-label">Shared</div>
        <div class="diff-card-sub">In both assemblies</div>
      </div>
      <div class="diff-card only-a">
        <div class="diff-card-n" id="dc-a">0</div>
        <div class="diff-card-label">Only in A</div>
        <div class="diff-card-sub" id="dc-a-label">—</div>
      </div>
      <div class="diff-card only-b">
        <div class="diff-card-n" id="dc-b">0</div>
        <div class="diff-card-label">Only in B</div>
        <div class="diff-card-sub" id="dc-b-label">—</div>
      </div>
      <div class="diff-card qty-diff">
        <div class="diff-card-n" id="dc-qty">0</div>
        <div class="diff-card-label">Qty Differs</div>
        <div class="diff-card-sub">Same part, different qty</div>
      </div>
    </div>
    <div class="diff-filters" id="diff-filters" style="display:none">
      <span class="diff-filter-label">Show:</span>
      <span class="diff-chip shared on" onclick="toggleChip(this,'shared')"><span class="diff-chip-dot"></span>Shared</span>
      <span class="diff-chip only-a on" onclick="toggleChip(this,'only-a')"><span class="diff-chip-dot"></span>Only A</span>
      <span class="diff-chip only-b on" onclick="toggleChip(this,'only-b')"><span class="diff-chip-dot"></span>Only B</span>
      <span class="diff-chip qty-diff on" onclick="toggleChip(this,'qty-diff')"><span class="diff-chip-dot"></span>Qty Diff</span>
    </div>
    <div class="diff-table-wrap" id="diff-table" style="display:none">
      <div class="diff-table-head">
        <div>Status</div>
        <div id="diff-col-a">Assembly A</div>
        <div id="diff-col-b">Assembly B</div>
      </div>
      <div id="diff-rows"></div>
    </div>
    <div class="compare-split" id="compare-split" style="display:none">
      <div class="compare-pane">
        <div class="compare-pane-head" id="cmp-head-a">BOM A</div>
        <div id="cmp-rows-a"></div>
      </div>
      <div class="compare-pane">
        <div class="compare-pane-head" id="cmp-head-b">BOM B</div>
        <div id="cmp-rows-b"></div>
      </div>
    </div>
    <div class="diff-empty" id="diff-empty-state">Select two assemblies above and click <strong>Run Comparison</strong> to see what's different between them.</div>
  </div>
</div>

<div class="toast" id="toast">
  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
  <span id="toast-msg">Copied</span>
</div>

<script>
const COLORS=['#00c896','#3b82f6','#a78bfa','#f59e0b','#ec4899','#10b981','#f97316','#06b6d4','#84cc16','#e879f9'];
let assemblies=[];
let bomVersions=[];
let compareRows=[];
let draggedElement=null;
let editingAsmIdx=null; // Track which assembly is being edited (tree view)
let editPanelAsmIdx=null; // Track assembly being edited in edit panel
let editViewMode='edit'; // 'edit' or 'view'
let editHistory=[]; // For undo functionality
let editDraggedRow=null;
let editSelectedRowIdx=null;

/* ════════ PARSE ════════ */
function parseData(raw){
  const lines=raw.trim().split('\n');
  let start=0;
  const h=lines[0].split('\t');
  if(h[1]==='Level'||h[2]==='Material'||isNaN(parseInt(h[1]))){start=1;}
  const asmMap=new Map();
  let colorIdx=0;
  for(let i=start;i<lines.length;i++){
    const c=lines[i].split('\t');
    if(c.length<6) continue;
    const level=parseInt((c[1]||'').trim());
    const material=(c[2]||'').trim();
    const matDesc=(c[3]||'').trim();
    const component=(c[4]||'').trim();
    const compDesc=(c[5]||'').trim();
    const qty=(c[6]||'').trim().replace(/,/g,'');
    const uom=(c[8]||'').trim();
    if(isNaN(level)||!material||!component) continue;
    if(!asmMap.has(material)){
      asmMap.set(material,{material,description:matDesc,color:COLORS[colorIdx%COLORS.length],rows:[]});
      colorIdx++;
    }
    const asm=asmMap.get(material);
    if(!asm.description&&matDesc) asm.description=matDesc;
    asm.rows.push({level,component,description:compDesc,qty,uom,supplier:'',id:uid()});
  }
  return [...asmMap.values()];
}

function buildTree(rows){
  const nodes=rows.map(r=>({...r,children:[],hasChildren:false}));
  const roots=[];
  const stack={};
  for(const node of nodes){
    let parent=null;
    for(let l=node.level-1;l>=1;l--){
      if(stack[l]){parent=stack[l];break;}
    }
    if(parent){parent.children.push(node);parent.hasChildren=true;}
    else{roots.push(node);}
    stack[node.level]=node;
    Object.keys(stack).forEach(k=>{if(+k>node.level)delete stack[k];});
  }
  return roots;
}

/* ════════ ENTRY POINT ════════ */
function go(){
  const raw=document.getElementById('raw').value;
  if(!raw.trim()){toast('No data entered');return;}
  assemblies=parseData(raw);
  if(!assemblies.length){toast('Could not parse any assemblies');return;}
  const project=(document.getElementById('meta-project').value||'').trim();
  const version=(document.getElementById('meta-version').value||'').trim();
  const date=(document.getElementById('meta-date').value||'').trim();
  const supplier=(document.getElementById('meta-supplier').value||'').trim();
  assemblies.forEach(a=>{
    a.project=project||a.project||'Untitled';
    a.version=version||a.version||'R1';
    a.date=date||a.date||new Date().toISOString().slice(0,10);
    a.rows.forEach(r=>{if(!r.supplier) r.supplier=supplier||'';});
    a.tree=buildTree(a.rows);
  });
  renderNav();renderAll();updateStats();populateDiffSelects();populateBulkTargets();
}

function quickAddRows(){
  const txt=document.getElementById('quick-add').value.trim();
  if(!txt){toast('Quick-Add is empty');return;}
  const project=(document.getElementById('meta-project').value||'Quick BOM').trim();
  const version=(document.getElementById('meta-version').value||'R1').trim();
  const date=(document.getElementById('meta-date').value||new Date().toISOString().slice(0,10)).trim();
  const supplierDefault=(document.getElementById('meta-supplier').value||'').trim();
  const material=`${project.replace(/\s+/g,'_').toUpperCase()}-${version}`;
  const asm={material,description:project,color:COLORS[assemblies.length%COLORS.length],rows:[],project,version,date};
  txt.split(/\n+/).forEach((ln,i)=>{
    const [component,qty,description,supplier]=ln.split('\t');
    if(!(component||'').trim()) return;
    asm.rows.push({level:1,component:(component||'').trim(),description:(description||'').trim(),qty:(qty||'1').trim(),uom:'NO',supplier:(supplier||supplierDefault||'').trim(),id:uid()});
  });
  if(!asm.rows.length){toast('No valid rows in Quick-Add');return;}
  asm.tree=buildTree(asm.rows);
  assemblies.push(asm);
  renderNav();renderAll();updateStats();populateDiffSelects();populateBulkTargets();
  toast(`Quick-added ${asm.rows.length} rows`);
}

function saveCurrentBom(){
  if(!assemblies.length){toast('Load or create a BOM first');return;}
  assemblies.forEach(a=>{
    const id=`${a.project||'P'}|${a.version||'R'}|${a.material}`;
    const existing=bomVersions.findIndex(v=>v.id===id);
    const snap=JSON.parse(JSON.stringify({...a,id,savedAt:new Date().toISOString()}));
    if(existing>=0) bomVersions[existing]=snap; else bomVersions.push(snap);
  });
  renderBomLibrary();
  toast('BOM version saved');
}

function renderBomLibrary(){
  const el=document.getElementById('bom-library');
  if(!bomVersions.length){el.innerHTML='<div class="nav-empty">No saved BOM versions</div>';return;}
  el.innerHTML='';
  bomVersions.forEach((b,idx)=>{
    const row=document.createElement('div');
    row.className='bom-lib-item';
    row.innerHTML=`<div class="nav-info"><div class="nav-code">${b.project||b.material} • ${b.version||''}</div><div class="nav-desc">${b.date||''} • ${b.material}</div></div>
      <button onclick="loadSavedBom(${idx})">Load</button>
      <button onclick="duplicateBom(${idx})">Duplicate</button>
      <button onclick="deleteBom(${idx})">Delete</button>`;
    el.appendChild(row);
  });
}

function loadSavedBom(idx){
  const b=bomVersions[idx]; if(!b) return;
  assemblies=[JSON.parse(JSON.stringify(b))];
  assemblies[0].color=COLORS[0];
  assemblies[0].rows.forEach(r=>{if(!r.id) r.id=uid();});
  assemblies[0].tree=buildTree(assemblies[0].rows);
  document.getElementById('meta-project').value=assemblies[0].project||'';
  document.getElementById('meta-version').value=assemblies[0].version||'';
  document.getElementById('meta-date').value=assemblies[0].date||'';
  renderNav();renderAll();updateStats();populateDiffSelects();populateBulkTargets();
}

function duplicateBom(idx){
  const b=bomVersions[idx]; if(!b) return;
  const cp=JSON.parse(JSON.stringify(b));
  cp.version=(cp.version||'R1')+'-COPY';
  cp.id=`${cp.project}|${cp.version}|${cp.material}`;
  bomVersions.push(cp);
  renderBomLibrary();
  toast('Duplicated BOM version');
}
function deleteBom(idx){bomVersions.splice(idx,1);renderBomLibrary();}

function populateBulkTargets(){
  const sel=document.getElementById('bulk-target');
  sel.innerHTML='<option value="">Select loaded assembly</option>';
  assemblies.forEach((a,i)=>{const o=document.createElement('option');o.value=i;o.textContent=`${a.material} — ${a.version||''}`;sel.appendChild(o);});
}

function applyBulkEdit(){
  const idx=document.getElementById('bulk-target').value;
  if(idx===''){toast('Select an assembly for bulk edit');return;}
  const sup=(document.getElementById('bulk-supplier').value||'').trim();
  const fac=parseFloat((document.getElementById('bulk-qty-factor').value||'').trim()||'0');
  const asm=assemblies[idx];
  let changed=0;
  asm.rows.forEach(r=>{
    if(sup){r.supplier=sup;changed++;}
    if(fac>0){const q=parseFloat(String(r.qty).replace(/,/g,'')); if(!isNaN(q)){r.qty=(q*fac).toFixed(3).replace(/\.000$/,'');changed++;}}
  });
  asm.tree=buildTree(asm.rows);
  renderAll();
  toast(`Bulk edit applied (${changed} updates)`);
}

/* ════════ NAV ════════ */
function renderNav(){
  const el=document.getElementById('nav-list');
  el.innerHTML='';
  assemblies.forEach((asm,idx)=>{
    const total=countNodes(asm.tree);
    const item=document.createElement('div');
    item.className='nav-item';
    item.dataset.idx=idx;
    item.innerHTML=`
      <div class="nav-dot" style="background:${asm.color}"></div>
      <div class="nav-info">
        <div class="nav-code">${asm.material}</div>
        <div class="nav-desc">${asm.description||'—'}</div>
      </div>
      <span class="nav-badge" style="background:${asm.color}22;color:${asm.color}">${total}</span>`;
    item.onclick=()=>{
      document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
      item.classList.add('active');
      const block=document.querySelector(`[data-asm="${idx}"]`);
      if(block) block.scrollIntoView({behavior:'smooth',block:'start'});
    };
    el.appendChild(item);
  });
}

function countNodes(nodes){
  let n=0;
  nodes.forEach(nd=>{n++;n+=countNodes(nd.children);});
  return n;
}

/* ════════ RENDER ALL ════════ */
function renderAll(){
  const area=document.getElementById('tree');
  area.innerHTML='';
  if(assemblies.length===1){
    setHeader(assemblies[0].material,assemblies[0].description,assemblies[0].color);
  }else{
    setHeader(`${assemblies.length} Assemblies`,'All assemblies shown below','var(--accent)');
  }
  assemblies.forEach((asm,idx)=>area.appendChild(makeAsmBlock(asm,idx)));
}

function setHeader(name,code,color){
  document.getElementById('hdr-name').textContent=name;
  document.getElementById('hdr-name').style.color=color;
  document.getElementById('hdr-code').textContent=code||'';
}

/* ════════ ASSEMBLY BLOCK ════════ */
function makeAsmBlock(asm,idx){
  const total=countNodes(asm.tree);
  const isEditing = editingAsmIdx === idx;
  const block=document.createElement('div');
  block.className='asm-block'+(isEditing?' edit-mode-active':'');
  block.dataset.asm=idx;
  block.style.cssText=`border-top:2px solid ${asm.color};`;

  const bar=document.createElement('div');
  bar.className='asm-bar';
  bar.innerHTML=`
    <div class="asm-accent" style="background:${asm.color}"></div>
    <div class="asm-bar-info">
      <div class="asm-bar-code">${asm.material}</div>
      <div class="asm-bar-desc">${asm.description||'No description'}</div>
    </div>
    <div class="asm-meta">
      <button class="mode-toggle ${isEditing?'active':''}" onclick="toggleAsmEdit(${idx})" title="${isEditing?'Exit edit mode':'Edit this assembly'}">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        ${isEditing?'Done':'Edit'}
      </button>
      <span class="asm-cnt" style="background:${asm.color}1a;color:${asm.color}">${total} parts</span>
      <svg class="asm-chev" style="transform:rotate(90deg)" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
    </div>`;

  const colHdr=document.createElement('div');
  colHdr.className='col-hdr rg'+(isEditing?'':' view-mode');
  if(isEditing){
    colHdr.innerHTML=`<span></span><span></span><span>Level</span><span>Component</span><span>Description</span><span style="text-align:right">Qty</span><span style="text-align:center">UoM</span><span style="text-align:center">Actions</span>`;
  }else{
    colHdr.innerHTML=`<span></span><span>Level</span><span>Component</span><span>Description</span><span style="text-align:right">Qty</span><span style="text-align:center">UoM</span><span></span>`;
  }

  const body=document.createElement('div');
  body.className='parts-body open'+(isEditing?' edit-mode':'');
  body.appendChild(colHdr);

  const partsDiv=document.createElement('div');
  asm.tree.forEach(nd=>partsDiv.appendChild(makePartWrap(nd,asm.color,idx)));
  body.appendChild(partsDiv);

  if(isEditing){
    const addZone=document.createElement('div');
    addZone.className='add-row-zone';
    addZone.innerHTML=`<button class="add-row-btn" onclick="addNewRow(${idx})"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add New Part</button>`;
    body.appendChild(addZone);
  }

  bar.onclick=(e)=>{
    if(e.target.closest('.mode-toggle')) return; // Don't toggle when clicking edit button
    const open=body.classList.toggle('open');
    bar.querySelector('.asm-chev').style.transform=open?'rotate(90deg)':'rotate(0)';
  };

  block.appendChild(bar);
  block.appendChild(body);
  return block;
}

/* ════════ PART ROW (EDITABLE) ════════ */
function makePartWrap(node,asmColor,asmIdx){
  const isEditing = editingAsmIdx === asmIdx;
  const wrap=document.createElement('div');
  wrap.className='part-wrap';
  wrap.dataset.comp=(node.component||'').toLowerCase();
  wrap.dataset.desc=(node.description||'').toLowerCase();
  wrap.dataset.nodeId=node.id;
  wrap.dataset.asmIdx=asmIdx;
  wrap.draggable=isEditing;

  if(isEditing){
    wrap.ondragstart=e=>{
      draggedElement=wrap;
      wrap.classList.add('dragging');
      e.dataTransfer.effectAllowed='move';
    };
    wrap.ondragend=e=>{
      wrap.classList.remove('dragging');
      document.querySelectorAll('.drag-over-top,.drag-over-bottom').forEach(el=>{
        el.classList.remove('drag-over-top','drag-over-bottom');
      });
    };
    wrap.ondragover=e=>{
      e.preventDefault();
      if(!draggedElement||draggedElement===wrap) return;
      const rect=wrap.getBoundingClientRect();
      const mid=rect.top+rect.height/2;
      wrap.classList.remove('drag-over-top','drag-over-bottom');
      if(e.clientY<mid){wrap.classList.add('drag-over-top');}
      else{wrap.classList.add('drag-over-bottom');}
    };
    wrap.ondrop=e=>{
      e.preventDefault();
      if(!draggedElement||draggedElement===wrap) return;
      const rect=wrap.getBoundingClientRect();
      const mid=rect.top+rect.height/2;
      const before=e.clientY<mid;
      if(before){wrap.parentNode.insertBefore(draggedElement,wrap);}
      else{wrap.parentNode.insertBefore(draggedElement,wrap.nextSibling);}
      reorderRows(asmIdx);
      toast('Row reordered');
    };
  }

  const lvCls=`l${Math.min(node.level,6)}`;
  const row=document.createElement('div');
  row.className='part-row rg'+(isEditing?'':' view-mode');

  if(isEditing){
    // Drag handle
    const drag=document.createElement('div');
    drag.className='drag-handle';
    drag.innerHTML=`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="9" y1="5" x2="9" y2="19"/><line x1="15" y1="5" x2="15" y2="19"/></svg>`;
    row.appendChild(drag);
  }

  // Toggle
  const tog=document.createElement('div');
  tog.className=`ptog${node.hasChildren?'':' leaf'}`;
  tog.innerHTML=`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>`;
  row.appendChild(tog);

  // Level
  const lv=mk('span',`lbadge ${lvCls}`,`L${node.level}`);
  row.appendChild(lv);

  // Component (editable)
  if(isEditing){
    const codeInput=document.createElement('input');
    codeInput.className='edit-field pcode';
    codeInput.value=node.component||'';
    codeInput.onchange=()=>{node.component=codeInput.value;updateNodeInAsm(asmIdx,node);};
    row.appendChild(codeInput);
  }else{
    const code=mk('div','pcode',node.component);
    code.title=node.component;
    row.appendChild(code);
  }

  // Description (editable)
  if(isEditing){
    const descInput=document.createElement('input');
    descInput.className='edit-field pdesc';
    descInput.value=node.description||'';
    descInput.onchange=()=>{node.description=descInput.value;updateNodeInAsm(asmIdx,node);};
    row.appendChild(descInput);
  }else{
    const desc=mk('div','pdesc',node.description||'—');
    desc.title=node.description;
    row.appendChild(desc);
  }

  // Qty (editable)
  if(isEditing){
    const qtyInput=document.createElement('input');
    qtyInput.className='edit-field pqty qty';
    qtyInput.value=node.qty||'';
    qtyInput.type='number';
    qtyInput.step='0.001';
    qtyInput.onchange=()=>{node.qty=qtyInput.value;updateNodeInAsm(asmIdx,node);};
    row.appendChild(qtyInput);
  }else{
    const qty=mk('div','pqty',node.qty||'—');
    row.appendChild(qty);
  }

  // UoM (editable)
  if(isEditing){
    const uomInput=document.createElement('input');
    uomInput.className='edit-field puom';
    uomInput.value=node.uom||'';
    uomInput.onchange=()=>{node.uom=uomInput.value;updateNodeInAsm(asmIdx,node);};
    row.appendChild(uomInput);
  }else{
    const uom=mk('div','puom',node.uom||'—');
    row.appendChild(uom);
  }

  // Actions / Copy
  if(isEditing){
    const actions=document.createElement('div');
    actions.className='edit-actions';
    const delBtn=document.createElement('button');
    delBtn.className='edit-btn del';
    delBtn.title='Delete row';
    delBtn.innerHTML=`<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`;
    delBtn.onclick=()=>deleteRow(asmIdx,node.id);
    const dupBtn=document.createElement('button');
    dupBtn.className='edit-btn add';
    dupBtn.title='Duplicate row';
    dupBtn.innerHTML=`<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;
    dupBtn.onclick=()=>duplicateRow(asmIdx,node.id);
    actions.appendChild(delBtn);
    actions.appendChild(dupBtn);
    row.appendChild(actions);
  }else{
    const copyBtn=document.createElement('button');
    copyBtn.className='copy-btn';
    copyBtn.title='Copy row';
    copyBtn.innerHTML=`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;
    copyBtn.onclick=e=>{e.stopPropagation();navigator.clipboard.writeText(`${node.component}\t${node.description}\t${node.qty}\t${node.uom}`);toast('Row copied');};
    row.appendChild(copyBtn);
  }

  wrap.appendChild(row);

  if(node.hasChildren){
    const cw=document.createElement('div');
    cw.className='child-wrap';
    cw.style.borderLeftColor=asmColor+'55';
    node.children.forEach(child=>cw.appendChild(makePartWrap(child,asmColor,asmIdx)));
    wrap.appendChild(cw);
    row.onclick=e=>{
      if(e.target.closest('.copy-btn')||e.target.closest('input')||e.target.closest('.edit-btn')) return;
      const open=cw.classList.toggle('open');
      tog.classList.toggle('open',open);
    };
  }
  return wrap;
}

function mk(tag,cls,text){const e=document.createElement(tag);e.className=cls;e.textContent=text;return e;}

/* ════════ EDIT MODE FUNCTIONS ════════ */
function toggleAsmEdit(idx){
  if(editingAsmIdx === idx){
    editingAsmIdx = null;
    toast('Edit mode disabled');
  }else{
    editingAsmIdx = idx;
    toast('Edit mode enabled for this assembly');
  }
  renderAll();
}

function updateNodeInAsm(asmIdx,node){
  const asm=assemblies[asmIdx];
  const row=asm.rows.find(r=>r.id===node.id);
  if(row){
    row.component=node.component;
    row.description=node.description;
    row.qty=node.qty;
    row.uom=node.uom;
  }
}

function reorderRows(asmIdx){
  const asm=assemblies[asmIdx];
  const block=document.querySelector(`[data-asm="${asmIdx}"]`);
  const wraps=Array.from(block.querySelectorAll('.part-wrap[data-node-id]'));
  const newOrder=wraps.map(w=>w.dataset.nodeId);
  asm.rows.sort((a,b)=>{
    const idxA=newOrder.indexOf(a.id);
    const idxB=newOrder.indexOf(b.id);
    return idxA-idxB;
  });
  asm.tree=buildTree(asm.rows);
}

function deleteRow(asmIdx,nodeId){
  if(!confirm('Delete this row?')) return;
  const asm=assemblies[asmIdx];
  asm.rows=asm.rows.filter(r=>r.id!==nodeId);
  asm.tree=buildTree(asm.rows);
  renderAll();
  toast('Row deleted');
}

function duplicateRow(asmIdx,nodeId){
  const asm=assemblies[asmIdx];
  const row=asm.rows.find(r=>r.id===nodeId);
  if(!row) return;
  const newRow={...row,id:uid(),component:row.component+'-COPY'};
  const idx=asm.rows.findIndex(r=>r.id===nodeId);
  asm.rows.splice(idx+1,0,newRow);
  asm.tree=buildTree(asm.rows);
  renderAll();
  toast('Row duplicated');
}

function addNewRow(asmIdx){
  const asm=assemblies[asmIdx];
  const newRow={level:1,component:'NEW-PART',description:'New component',qty:'1',uom:'NO',supplier:'',id:uid()};
  asm.rows.push(newRow);
  asm.tree=buildTree(asm.rows);
  renderAll();
  toast('New row added');
}

/* ════════ EXPORT FUNCTIONS ════════ */
function toggleExportMenu(){
  document.getElementById('export-dropdown').classList.toggle('show');
}

function exportCurrentCSV(){
  if(!assemblies.length){toast('No data to export');return;}
  const lines=[`Level,Component,Description,Qty,UoM,Supplier`];
  assemblies.forEach(a=>{
    a.rows.forEach(r=>{
      lines.push(`${r.level},"${r.component||''}","${r.description||''}",${r.qty||''},${r.uom||''},"${r.supplier||''}"`);
    });
  });
  downloadFile(lines.join('\n'),`BOM_${assemblies[0].material}_${new Date().toISOString().slice(0,10)}.csv`,'text/csv');
  toggleExportMenu();
  toast('CSV exported');
}

function exportCurrentExcel(){
  if(!assemblies.length){toast('No data to export');return;}
  const lines=[`Level\tComponent\tDescription\tQty\tUoM\tSupplier`];
  assemblies.forEach(a=>{
    a.rows.forEach(r=>{
      lines.push(`${r.level}\t${r.component||''}\t${r.description||''}\t${r.qty||''}\t${r.uom||''}\t${r.supplier||''}`);
    });
  });
  downloadFile(lines.join('\n'),`BOM_${assemblies[0].material}_${new Date().toISOString().slice(0,10)}.tsv`,'text/tab-separated-values');
  toggleExportMenu();
  toast('TSV exported');
}

function saveAsNewBOM(){
  if(!assemblies.length){toast('No data to save');return;}
  const sourceIdx=editPanelAsmIdx!==null ? editPanelAsmIdx : 0;
  createClonedBomFromAssembly(sourceIdx,{fromExportMenu:true});
}

function cloneEditedAssembly(){
  if(editPanelAsmIdx===null){toast('Select an assembly first');return;}
  createClonedBomFromAssembly(editPanelAsmIdx,{fromExportMenu:false});
}

function createClonedBomFromAssembly(sourceIdx,{fromExportMenu=false}={}){
  const src=assemblies[sourceIdx];
  if(!src){toast('Source assembly not found');return;}

  const newMaterial=prompt('New BOM code / material:',`${src.material}-NEW`);
  if(!newMaterial) return;
  const newVersion=prompt('New BOM version:',`${src.version||'R1'}-NEW`);
  if(newVersion===null) return;
  const newProject=prompt('Project name for new BOM:',src.project||src.description||'Derived BOM');
  if(newProject===null) return;

  const copy=JSON.parse(JSON.stringify(src));
  copy.material=newMaterial.trim()||`${src.material}-NEW`;
  copy.version=(newVersion||`${src.version||'R1'}-NEW`).trim();
  copy.project=(newProject||src.project||src.description||'Derived BOM').trim();
  copy.description=copy.project;
  copy.date=new Date().toISOString().slice(0,10);
  copy.rows=(copy.rows||[]).map(r=>({...r,id:uid()}));
  copy.tree=buildTree(copy.rows);

  const id=`${copy.project||'P'}|${copy.version||'R'}|${copy.material}`;
  const existing=bomVersions.findIndex(v=>v.id===id);
  const snap={...JSON.parse(JSON.stringify(copy)),id,savedAt:new Date().toISOString()};
  if(existing>=0) bomVersions[existing]=snap; else bomVersions.push(snap);

  assemblies.push({...copy,color:COLORS[assemblies.length%COLORS.length]});
  renderBomLibrary();
  renderNav();
  renderAll();
  updateStats();
  populateDiffSelects();
  populateBulkTargets();
  populateEditSelect();
  if(fromExportMenu) toggleExportMenu();
  toast(`New BOM created from ${src.material}`);
}

function changeRowLevel(idx,delta){
  if(editPanelAsmIdx===null) return;
  const asm=assemblies[editPanelAsmIdx];
  if(!asm || !asm.rows[idx]) return;
  const next=Math.max(1,Math.min(6,(parseInt(asm.rows[idx].level,10)||1)+delta));
  if(next===(parseInt(asm.rows[idx].level,10)||1)) return;
  saveEditHistory();
  asm.rows[idx].level=next;
  asm.tree=buildTree(asm.rows);
  renderEditTable();
}

function setRowIndent(idx,indentValue){
  if(editPanelAsmIdx===null) return;
  const asm=assemblies[editPanelAsmIdx];
  if(!asm || !asm.rows[idx]) return;
  const indent=Math.max(0,Math.min(5,parseInt(indentValue,10)||0));
  const nextLevel=indent+1;
  if(nextLevel===(parseInt(asm.rows[idx].level,10)||1)) return;
  saveEditHistory();
  asm.rows[idx].level=nextLevel;
  asm.tree=buildTree(asm.rows);
  renderEditTable();
}

function downloadFile(content,filename,type){
  const blob=new Blob([content],{type});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=filename;
  a.click();
  URL.revokeObjectURL(url);
}

// Close export menu when clicking outside
document.addEventListener('click',e=>{
  if(!e.target.closest('.export-menu')){
    document.getElementById('export-dropdown').classList.remove('show');
  }
});

/* ════════ STATS ════════ */
function updateStats(){
  let totalRows=0,maxD=0;
  assemblies.forEach(a=>{totalRows+=a.rows.length;a.rows.forEach(r=>{maxD=Math.max(maxD,r.level);});});
  document.getElementById('s-asm').textContent=assemblies.length;
  document.getElementById('s-rows').textContent=totalRows;
  document.getElementById('s-max').textContent=maxD;
  document.getElementById('sb-stats').style.display='grid';
}

/* ════════ SEARCH ════════ */
function doSearch(q){
  const ql=q.toLowerCase().trim();
  document.querySelectorAll('.part-wrap').forEach(wrap=>{
    const row=wrap.querySelector('.part-row');
    const hit=ql&&((wrap.dataset.comp||'').includes(ql)||(wrap.dataset.desc||'').includes(ql));
    row.classList.toggle('match',!!hit);
    if(hit){
      let p=wrap.parentElement;
      while(p){
        if(p.classList.contains('child-wrap')){
          p.classList.add('open');
          const prev=p.previousElementSibling;
          if(prev) prev.querySelector('.ptog')?.classList.add('open');
        }
        if(p.classList.contains('parts-body')) p.classList.add('open');
        p=p.parentElement;
      }
    }
  });
  if(document.getElementById('diff-panel').classList.contains('visible') && compareRows.length){
    renderCompareSplit();
  }
}

/* ════════ EXPAND / COLLAPSE ════════ */
function expandAll(){
  document.querySelectorAll('.child-wrap').forEach(e=>e.classList.add('open'));
  document.querySelectorAll('.ptog:not(.leaf)').forEach(e=>e.classList.add('open'));
  document.querySelectorAll('.parts-body').forEach(e=>e.classList.add('open'));
  document.querySelectorAll('.asm-chev').forEach(e=>e.style.transform='rotate(90deg)');
}
function collapseAll(){
  document.querySelectorAll('.child-wrap').forEach(e=>e.classList.remove('open'));
  document.querySelectorAll('.ptog').forEach(e=>e.classList.remove('open'));
  document.querySelectorAll('.parts-body').forEach(e=>e.classList.remove('open'));
  document.querySelectorAll('.asm-chev').forEach(e=>e.style.transform='rotate(0deg)');
}

/* ════════ HELPERS ════════ */
function uid(){return Math.random().toString(36).slice(2,9);}
function toast(msg){
  const t=document.getElementById('toast');
  document.getElementById('toast-msg').textContent=msg;
  t.classList.add('on');
  clearTimeout(t._t);
  t._t=setTimeout(()=>t.classList.remove('on'),2200);
}
function clearAll(){
  document.getElementById('raw').value='';
  document.getElementById('quick-add').value='';
  assemblies=[];
  lastDiffResults=[];
  compareRows=[];
  document.getElementById('tree').innerHTML=`<div class="empty"><div class="empty-ring"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg></div><div class="empty-title">No BOM data loaded</div><div class="empty-desc">Paste your data and click Generate.</div></div>`;
  document.getElementById('nav-list').innerHTML='<div class="nav-empty">No data loaded yet</div>';
  document.getElementById('sb-stats').style.display='none';
  setHeader('No assembly selected','Load data to begin','var(--fg3)');
  ['sel-a','sel-b'].forEach(id=>{
    const s=document.getElementById(id);
    s.innerHTML='<option value="">— Select assembly —</option>';
  });
  document.getElementById('bulk-target').innerHTML='<option value="">Select loaded assembly</option>';
  document.getElementById('diff-summary').style.display='none';
  document.getElementById('diff-filters').style.display='none';
  document.getElementById('diff-table').style.display='none';
  document.getElementById('compare-split').style.display='none';
  document.getElementById('diff-export-btn').style.display='none';
  document.getElementById('diff-empty-state').style.display='';
  document.getElementById('diff-rows').innerHTML='';
  document.getElementById('cmp-rows-a').innerHTML='';
  document.getElementById('cmp-rows-b').innerHTML='';
  editingAsmIdx=null;
  editPanelAsmIdx=null;
  editHistory=[];
  document.getElementById('edit-asm-select').innerHTML='<option value="">— Select assembly to edit —</option>';
  switchTab('tree');
}

/* ════════ SAMPLE DATA ════════ */
const SAMPLE=`Plant\tLevel\tMaterial\tMaterial Description\tComponent\tComponent Description\tComp. Qty(CUn)\tComp. Qty(BUn)\tUOM\tMaterial Type
5600\t1\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO00100587\tSIKAMELT-700\t39\t39\tKG\tROH
5600\t1\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tS3670155F3\tHSG ASM-HL-CONDOR-RHD-RH-24V\t1\t1\tNO\tHALB
5600\t2\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO01610254\tSEALING RING\t1\t1\tNO\tROH
5600\t2\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO07100006\tGEAR ASM-ADJUSTER-HORIZONTAL\t1\t1\tNO\tROH
5600\t2\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tS3670155F2\tREF ASSY-HL-CONDOR-RHD-RH-24V\t1\t1\tNO\tHALB
5600\t3\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO02907174\tPIVOT BUSH\t1\t1\tNO\tROH
5600\t3\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO01610404\tSCREW 5X DELT PT50\t1\t1\tNO\tROH
5600\t3\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tS367015516\tREF-HL-LD-CONDOR-RHD-RH\t1\t1\tNO\tHALB
5600\t4\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tS367015514\tREF-HL-LD-CONDOR-RHD-RH-2W\t1\t1\tNO\tHALB
5600\t5\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO02801409\tBASECOAT MATERIAL\t19\t19\tG\tROH
5600\t5\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO02801400\tSOLVENT BASECOAT-BUTYL ACETATE\t28\t28\tL\tROH
5600\t6\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tRM01220116\tBMC 3100 7250-10A 109 LD\t617\t617\tKG\tROH
5600\t1\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tS3670155F1\tLENS ASSEMBLY-HL-CONDO-RH\t1\t1\tNO\tHALB
5600\t2\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tS367013402\tREFLECTOR-TURN-CONDO-RH\t1\t1\tNO\tHALB
5600\t3\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO02801402\tHEXAMETHYLDISILOXANE HMDSO\t60\t0.060\tG\tROH
5600\t3\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tS367013404\tREFLECTOR-TURN-CONDO-RH-1W\t1\t1\tNO\tHALB
5600\t4\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tRM01220107\tTHERMOPLAST-PBT TORAYCON\t224\t224\tKG\tROH
5600\t1\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO02601474\tCLOSEOUT-GAP HIDER-LH\t1\t1\tNO\tROH
5600\t1\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO01303604\tVNT ASY HD LP\t2\t2\tNO\tROH
5600\t1\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tBO00100587\tSIKAMELT-700\t39\t39\tKG\tROH
5600\t1\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tS3670154F3\tHSG ASM-HL-CONDOR-RHD-LH-24V\t1\t1\tNO\tHALB
5600\t2\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tBO01610117\tSCREW-ADJUSTER-HORIZONTAL CAP\t1\t1\tNO\tROH
5600\t2\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tBO01610118\tLEVER-ADJUSTER-MOTOR\t1\t1\tNO\tROH
5600\t2\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tS3670154F2\tREF ASSY-HL-CONDOR-RHD-LH-24V\t1\t1\tNO\tHALB
5600\t3\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tBO02907174\tPIVOT BUSH\t1\t1\tNO\tROH
5600\t3\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tS367015416\tREF-HL-LD-CONDOR-RHD-LH\t1\t1\tNO\tHALB
5600\t4\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tS367015414\tREF-HL-LD-CONDOR-RHD-LH-2W\t1\t1\tNO\tHALB
5600\t5\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tBO02801400\tSOLVENT BASECOAT-BUTYL ACETATE\t28\t28\tL\tROH
5600\t6\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tRM01220116\tBMC 3100 7250-10A 109 LD\t638\t638\tKG\tROH
5600\t1\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tBO01610017\tBRKT-MOUNTING-CONDOR HL-LH\t1\t1\tNO\tROH
5600\t1\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tS3670154F1\tLENS ASSEMBLY-HL-CONDO-LH\t1\t1\tNO\tHALB
5600\t2\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tS367015402\tLENS-OTR HL-CONDO-LH\t1\t1\tNO\tHALB
5600\t3\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tBO02801410\tUVHC3000 HARD COAT\t11\t11\tG\tROH
5600\t3\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tS367015406\tLENS-OTR HL-CONDO-LH-1W\t1\t1\tNO\tHALB
5600\t4\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tRM01220080\tMAKROLON AL2647 CLEAR\t474\t474\tKG\tROH`;

function loadSample(){document.getElementById('raw').value=SAMPLE;toast('Sample data loaded');}

document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){document.getElementById('search').value='';doSearch('');}
  if((e.ctrlKey||e.metaKey)&&e.key==='f'){e.preventDefault();document.getElementById('search').focus();}
});
const qa=document.getElementById('quick-add');
qa?.addEventListener('keydown',e=>{
  if(e.key==='Tab'){e.preventDefault();const t=e.target;t.setRangeText('\t',t.selectionStart,t.selectionEnd,'end');}
});
document.getElementById('meta-date').value=new Date().toISOString().slice(0,10);

/* ════════ TAB SWITCHING ════════ */
function switchTab(tab){
  const isTree = tab==='tree';
  const isEdit = tab==='edit';
  const isDiff = tab==='diff';
  
  document.getElementById('tab-tree').classList.toggle('active',isTree);
  document.getElementById('tab-edit').classList.toggle('active',isEdit);
  document.getElementById('tab-diff').classList.toggle('active',isDiff);
  
  document.getElementById('tree').style.display = isTree ? '' : 'none';
  document.getElementById('edit-panel').classList.toggle('visible',isEdit);
  document.getElementById('diff-panel').classList.toggle('visible',isDiff);
  
  document.querySelector('.ctrls').style.display = '';
  
  if(isEdit){
    populateEditSelect();
    if(editPanelAsmIdx !== null){
      renderEditTable();
    }
  }
}

/* ════════ EDIT PANEL FUNCTIONS ════════ */
function populateEditSelect(){
  const sel=document.getElementById('edit-asm-select');
  const prev=sel.value;
  sel.innerHTML='<option value="">— Select assembly to edit —</option>';
  assemblies.forEach((a,i)=>{
    const opt=document.createElement('option');
    opt.value=i;
    opt.textContent=`${a.material} — ${a.description||'No description'}`;
    sel.appendChild(opt);
  });
  if(prev!=='' && assemblies[prev]) sel.value=prev;
}

function selectEditAsm(){
  const idx=document.getElementById('edit-asm-select').value;
  if(idx===''){
    editPanelAsmIdx=null;
    document.getElementById('edit-table-container').innerHTML=`
      <div class="edit-empty">
        <div class="empty-ring">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
        </div>
        <div class="empty-title">No Assembly Selected</div>
        <div class="empty-desc">Select an assembly from the dropdown above to begin editing</div>
      </div>`;
    return;
  }
  editPanelAsmIdx=parseInt(idx);
  editHistory=[];
  editSelectedRowIdx=null;
  renderEditTable();
  toast('Assembly loaded for editing');
}

function setEditViewMode(mode){
  editViewMode=mode;
  document.getElementById('view-only-btn').classList.toggle('active',mode==='view');
  document.getElementById('edit-mode-btn').classList.toggle('active',mode==='edit');
  renderEditTable();
}

function renderEditTable(){
  if(editPanelAsmIdx===null) return;
  const asm=assemblies[editPanelAsmIdx];
  const container=document.getElementById('edit-table-container');
  if(editSelectedRowIdx!==null && (editSelectedRowIdx<0 || editSelectedRowIdx>=asm.rows.length)) editSelectedRowIdx=null;
  const isEdit=editViewMode==='edit';
  
  container.innerHTML='';
  
  // Header
  const header=document.createElement('div');
  header.className='edit-table-header';
  if(isEdit){
    header.innerHTML=`
      <span></span>
      <span>Level</span>
      <span>Indent</span>
      <span>Component</span>
      <span>Description</span>
      <span>Qty</span>
      <span>UoM</span>
      <span>Actions</span>`;
  }else{
    header.innerHTML=`
      <span></span>
      <span>Level</span>
      <span>Indent</span>
      <span>Component</span>
      <span>Description</span>
      <span>Qty</span>
      <span>UoM</span>
      <span></span>`;
  }
  container.appendChild(header);
  
  // Body
  const body=document.createElement('div');
  body.className='edit-table-body';
  
  asm.rows.forEach((row,idx)=>{
    const rowEl=createEditRow(row,idx,isEdit);
    body.appendChild(rowEl);
  });
  
  container.appendChild(body);
}

function createEditRow(row,idx,isEdit){
  const rowEl=document.createElement('div');
  rowEl.className='edit-row'+(editSelectedRowIdx===idx?' selected':'');
  rowEl.dataset.rowIdx=idx;
  rowEl.onclick=e=>{
    if(e.target.closest('input,button,select,textarea')) return;
    editSelectedRowIdx=idx;
    renderEditTable();
  };
  rowEl.draggable=isEdit;
  
  if(isEdit){
    rowEl.ondragstart=e=>{
      editDraggedRow=rowEl;
      rowEl.classList.add('dragging');
      e.dataTransfer.effectAllowed='move';
    };
    rowEl.ondragend=e=>{
      rowEl.classList.remove('dragging');
      document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
    };
    rowEl.ondragover=e=>{
      e.preventDefault();
      if(!editDraggedRow||editDraggedRow===rowEl) return;
      rowEl.classList.add('drag-over');
    };
    rowEl.ondragleave=e=>{
      rowEl.classList.remove('drag-over');
    };
    rowEl.ondrop=e=>{
      e.preventDefault();
      if(!editDraggedRow||editDraggedRow===rowEl) return;
      rowEl.classList.remove('drag-over');
      
      const fromIdx=parseInt(editDraggedRow.dataset.rowIdx);
      const toIdx=parseInt(rowEl.dataset.rowIdx);
      
      saveEditHistory();
      const asm=assemblies[editPanelAsmIdx];
      const item=asm.rows.splice(fromIdx,1)[0];
      asm.rows.splice(toIdx,0,item);
      editSelectedRowIdx=toIdx;
      asm.tree=buildTree(asm.rows);
      
      renderEditTable();
      toast('Row reordered');
    };
  }
  
  const lvCls=`l${Math.min(row.level,6)}`;
  const indent=row.level-1;
  
  // Drag handle
  if(isEdit){
    const drag=document.createElement('div');
    drag.className='edit-drag-handle';
    drag.innerHTML=`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="9" y1="5" x2="9" y2="19"/><line x1="15" y1="5" x2="15" y2="19"/></svg>`;
    rowEl.appendChild(drag);
  }else{
    rowEl.appendChild(document.createElement('div'));
  }
  
  // Level badge
  const levelBadge=document.createElement('div');
  levelBadge.className=`edit-level-badge ${lvCls}`;
  levelBadge.textContent=`L${row.level}`;
  rowEl.appendChild(levelBadge);
  
  // Indent / level controls
  if(isEdit){
    const indentWrap=document.createElement('div');
    indentWrap.className='edit-indent-controls';

    const decBtn=document.createElement('button');
    decBtn.className='edit-indent-btn';
    decBtn.type='button';
    decBtn.textContent='−';
    decBtn.title='Outdent (decrease level)';
    decBtn.onclick=()=>changeRowLevel(idx,-1);

    const indentInput=document.createElement('input');
    indentInput.className='edit-input edit-indent-input';
    indentInput.type='number';
    indentInput.min='0';
    indentInput.max='5';
    indentInput.value=String(indent);
    indentInput.title='Indent level (0 = top level)';
    indentInput.onchange=()=>setRowIndent(idx,indentInput.value);

    const incBtn=document.createElement('button');
    incBtn.className='edit-indent-btn';
    incBtn.type='button';
    incBtn.textContent='+';
    incBtn.title='Indent (increase level)';
    incBtn.onclick=()=>changeRowLevel(idx,1);

    indentWrap.append(decBtn,indentInput,incBtn);
    rowEl.appendChild(indentWrap);
  }else{
    const indentEl=document.createElement('div');
    indentEl.className='edit-level-chip';
    indentEl.textContent=`${indent}`;
    indentEl.title=`Indent: ${indent}`;
    rowEl.appendChild(indentEl);
  }
  
  // Component
  if(isEdit){
    const compInput=document.createElement('input');
    compInput.className='edit-input';
    compInput.value=row.component||'';
    compInput.onchange=()=>{
      saveEditHistory();
      row.component=compInput.value;
      assemblies[editPanelAsmIdx].tree=buildTree(assemblies[editPanelAsmIdx].rows);
    };
    rowEl.appendChild(compInput);
  }else{
    const comp=document.createElement('div');
    comp.className='edit-text code';
    comp.textContent=row.component||'—';
    comp.title=row.component;
    rowEl.appendChild(comp);
  }
  
  // Description
  if(isEdit){
    const descInput=document.createElement('input');
    descInput.className='edit-input';
    descInput.value=row.description||'';
    descInput.onchange=()=>{
      saveEditHistory();
      row.description=descInput.value;
    };
    rowEl.appendChild(descInput);
  }else{
    const desc=document.createElement('div');
    desc.className='edit-text';
    desc.textContent=row.description||'—';
    desc.title=row.description;
    rowEl.appendChild(desc);
  }
  
  // Qty
  if(isEdit){
    const qtyInput=document.createElement('input');
    qtyInput.className='edit-input qty';
    qtyInput.type='number';
    qtyInput.step='0.001';
    qtyInput.value=row.qty||'';
    qtyInput.onchange=()=>{
      saveEditHistory();
      row.qty=qtyInput.value;
    };
    rowEl.appendChild(qtyInput);
  }else{
    const qty=document.createElement('div');
    qty.className='edit-text';
    qty.style.textAlign='right';
    qty.textContent=row.qty||'—';
    rowEl.appendChild(qty);
  }
  
  // UoM
  if(isEdit){
    const uomInput=document.createElement('input');
    uomInput.className='edit-input';
    uomInput.value=row.uom||'';
    uomInput.onchange=()=>{
      saveEditHistory();
      row.uom=uomInput.value;
    };
    rowEl.appendChild(uomInput);
  }else{
    const uom=document.createElement('div');
    uom.className='edit-text';
    uom.style.textAlign='center';
    uom.textContent=row.uom||'—';
    rowEl.appendChild(uom);
  }
  
  // Actions
  if(isEdit){
    const actions=document.createElement('div');
    actions.className='edit-row-actions';
    
    const childBtn=document.createElement('button');
    childBtn.className='edit-icon-btn add';
    childBtn.title='Add child under this row';
    childBtn.innerHTML=`<svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 4v6a2 2 0 0 0 2 2h12"/><line x1="18" y1="9" x2="18" y2="15"/><line x1="15" y1="12" x2="21" y2="12"/></svg>`;
    childBtn.onclick=()=>addChildPart(idx);

    const belowBtn=document.createElement('button');
    belowBtn.className='edit-icon-btn add';
    belowBtn.title='Add below this row';
    belowBtn.innerHTML=`<svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="12" x2="14" y2="12"/><line x1="18" y1="9" x2="18" y2="15"/><line x1="15" y1="12" x2="21" y2="12"/></svg>`;
    belowBtn.onclick=()=>addSiblingBelow(idx);

    const dupBtn=document.createElement('button');
    dupBtn.className='edit-icon-btn dup';
    dupBtn.title='Duplicate';
    dupBtn.innerHTML=`<svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;
    dupBtn.onclick=()=>duplicateEditRow(idx);
    
    const delBtn=document.createElement('button');
    delBtn.className='edit-icon-btn del';
    delBtn.title='Delete';
    delBtn.innerHTML=`<svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`;
    delBtn.onclick=()=>deleteEditRow(idx);
    
    actions.appendChild(childBtn);
    actions.appendChild(belowBtn);
    actions.appendChild(dupBtn);
    actions.appendChild(delBtn);
    rowEl.appendChild(actions);
  }else{
    rowEl.appendChild(document.createElement('div'));
  }
  
  return rowEl;
}

function saveEditHistory(){
  if(editPanelAsmIdx===null) return;
  const snapshot=JSON.parse(JSON.stringify(assemblies[editPanelAsmIdx].rows));
  editHistory.push(snapshot);
  if(editHistory.length>50) editHistory.shift(); // Keep last 50 changes
}

function undoLastChange(){
  if(!editHistory.length){toast('Nothing to undo');return;}
  const prevState=editHistory.pop();
  assemblies[editPanelAsmIdx].rows=prevState;
  assemblies[editPanelAsmIdx].tree=buildTree(prevState);
  renderEditTable();
  toast('Undone');
}

function addNewRowEdit(){
  if(editPanelAsmIdx===null){toast('Select an assembly first');return;}
  if(editSelectedRowIdx!==null){
    addSiblingBelow(editSelectedRowIdx);
    return;
  }
  insertPartAt({insertAt:null,level:1,message:'New top-level part added'});
}

function addChildPartFromSelection(){
  if(editPanelAsmIdx===null){toast('Select an assembly first');return;}
  if(editSelectedRowIdx===null){toast('Select a row, then click Add Child');return;}
  addChildPart(editSelectedRowIdx);
}

function addSiblingPartFromSelection(){
  if(editPanelAsmIdx===null){toast('Select an assembly first');return;}
  if(editSelectedRowIdx===null){toast('Select a row, then click Add Below');return;}
  addSiblingBelow(editSelectedRowIdx);
}

function subtreeEndIndex(rows,startIdx){
  const base=(rows[startIdx]?.level)||1;
  let i=startIdx+1;
  while(i<rows.length && (rows[i].level||1)>base) i++;
  return i;
}

function addChildPart(idx){
  const asm=assemblies[editPanelAsmIdx];
  if(!asm || !asm.rows[idx]) return;
  const level=Math.min(6,(asm.rows[idx].level||1)+1);
  const insertAt=subtreeEndIndex(asm.rows,idx);
  insertPartAt({insertAt,level,message:`Child part added under ${asm.rows[idx].component||'row'}`});
}

function addSiblingBelow(idx){
  const asm=assemblies[editPanelAsmIdx];
  if(!asm || !asm.rows[idx]) return;
  const level=asm.rows[idx].level||1;
  const insertAt=subtreeEndIndex(asm.rows,idx);
  insertPartAt({insertAt,level,message:'Part added below selected row'});
}

function insertPartAt({insertAt=null,level=1,message='New part added'}={}){
  if(editPanelAsmIdx===null) return;
  const asm=assemblies[editPanelAsmIdx];
  saveEditHistory();
  const newRow={
    level:Math.max(1,Math.min(6,level||1)),
    component:'NEW-PART-'+uid().slice(0,4).toUpperCase(),
    description:'New component',
    qty:'1',
    uom:'NO',
    supplier:'',
    id:uid()
  };
  const at=(insertAt===null || insertAt>asm.rows.length) ? asm.rows.length : Math.max(0,insertAt);
  asm.rows.splice(at,0,newRow);
  editSelectedRowIdx=at;
  asm.tree=buildTree(asm.rows);
  renderEditTable();
  toast(message);
}

function duplicateEditRow(idx){
  if(editPanelAsmIdx===null) return;
  saveEditHistory();
  const asm=assemblies[editPanelAsmIdx];
  const row=asm.rows[idx];
  const newRow={...row,id:uid(),component:row.component+'-COPY'};
  asm.rows.splice(idx+1,0,newRow);
  editSelectedRowIdx=idx+1;
  asm.tree=buildTree(asm.rows);
  renderEditTable();
  toast('Row duplicated');
}

function deleteEditRow(idx){
  if(editPanelAsmIdx===null) return;
  if(!confirm('Delete this row?')) return;
  saveEditHistory();
  const asm=assemblies[editPanelAsmIdx];
  asm.rows.splice(idx,1);
  if(editSelectedRowIdx!==null){
    if(editSelectedRowIdx===idx) editSelectedRowIdx=Math.min(idx,asm.rows.length-1);
    else if(editSelectedRowIdx>idx) editSelectedRowIdx--;
  }
  asm.tree=buildTree(asm.rows);
  renderEditTable();
  toast('Row deleted');
}

function saveEditChanges(){
  if(editPanelAsmIdx===null){toast('No assembly selected');return;}
  editHistory=[];
  toast('Changes saved to current session');
  updateStats();
  renderNav();
}

/* ════════ DIFF FUNCTIONS ════════ */
function getComparePool(){return bomVersions.length ? bomVersions : assemblies;}

function populateDiffSelects(){
  const pool=getComparePool();
  ['sel-a','sel-b'].forEach(id=>{
    const sel=document.getElementById(id);
    const prev=sel.value;
    sel.innerHTML='<option value="">— Select BOM —</option>';
    pool.forEach((a,i)=>{
      const opt=document.createElement('option');
      opt.value=i;
      opt.textContent=`${a.project||a.material} ${a.version?('('+a.version+')'):''} — ${a.material}`;
      sel.appendChild(opt);
    });
    if(prev!=='' && pool[prev]) sel.value=prev;
  });
}

function parseQty(s){
  if(s==null) return 0;
  return parseFloat(String(s).replace(/,/g,'')) || 0;
}

function buildPartMap(asm){
  const map=new Map();
  asm.rows.forEach(r=>{
    const key=(r.component||'').trim();
    if(!key) return;
    if(!map.has(key)) map.set(key,{comp:key,description:r.description||'',supplier:r.supplier||'',qty:0,uom:r.uom||'NO'});
    const it=map.get(key);
    it.qty += parseQty(r.qty);
    if(!it.description && r.description) it.description=r.description;
    if(!it.supplier && r.supplier) it.supplier=r.supplier;
    if(!it.uom && r.uom) it.uom=r.uom;
  });
  return map;
}

function diffAssemblies(asmA, asmB){
  const mapA=buildPartMap(asmA);
  const mapB=buildPartMap(asmB);
  const keys=[...new Set([...mapA.keys(),...mapB.keys()])].sort((a,b)=>a.localeCompare(b));
  const rows=[];
  keys.forEach(k=>{
    const a=mapA.get(k)||null;
    const b=mapB.get(k)||null;
    if(a&&b){
      const sameQty=Math.abs(a.qty-b.qty)<0.0001;
      const sameSup=(a.supplier||'')===(b.supplier||'');
      const type=(sameQty&&sameSup)?'shared':'qty-diff';
      rows.push({comp:k,type,a:{...a,qty:String(a.qty)},b:{...b,qty:String(b.qty)}});
    }else if(a){
      rows.push({comp:k,type:'only-a',a:{...a,qty:String(a.qty)},b:null});
    }else{
      rows.push({comp:k,type:'only-b',a:null,b:{...b,qty:String(b.qty)}});
    }
  });
  return rows;
}

let lastDiffResults=[];
let activeFilters=new Set(['shared','only-a','only-b','qty-diff']);

function runDiff(){
  const idxA=document.getElementById('sel-a').value;
  const idxB=document.getElementById('sel-b').value;
  if(idxA===''||idxB===''){toast('Select two assemblies to compare');return;}
  if(idxA===idxB){toast('Select two different assemblies');return;}

  const pool=getComparePool();
  const asmA=pool[idxA];
  const asmB=pool[idxB];
  lastDiffResults=diffAssemblies(asmA,asmB);
  compareRows=lastDiffResults.map(r=>({
    comp:r.comp,
    a:r.a,b:r.b,
    type:r.type==='only-b'?'add':r.type==='only-a'?'del':r.type==='qty-diff'?'mod':'same'
  }));

  document.getElementById('diff-col-a').innerHTML=`<span style="color:#ef4444">A</span> — ${asmA.material}`;
  document.getElementById('diff-col-b').innerHTML=`<span style="color:#22c55e">B</span> — ${asmB.material}`;
  document.getElementById('cmp-head-a').textContent=`BOM A — ${asmA.material} (${asmA.version||''})`;
  document.getElementById('cmp-head-b').textContent=`BOM B — ${asmB.material} (${asmB.version||''})`;

  const counts={shared:0,'only-a':0,'only-b':0,'qty-diff':0};
  lastDiffResults.forEach(r=>counts[r.type]++);
  document.getElementById('dc-shared').textContent=counts['shared'];
  document.getElementById('dc-a').textContent=counts['only-a'];
  document.getElementById('dc-b').textContent=counts['only-b'];
  document.getElementById('dc-qty').textContent=counts['qty-diff'];
  document.getElementById('dc-a-label').textContent=asmA.material;
  document.getElementById('dc-b-label').textContent=asmB.material;

  document.getElementById('diff-summary').style.display='grid';
  document.getElementById('diff-filters').style.display='flex';
  document.getElementById('diff-table').style.display='block';
  document.getElementById('compare-split').style.display='grid';
  document.getElementById('diff-empty-state').style.display='none';
  document.getElementById('diff-export-btn').style.display='inline-flex';

  renderDiffRows();
  renderCompareSplit();
  toast(`Comparison complete — ${lastDiffResults.length} aligned part numbers`);
}

function renderDiffRows(){
  const container=document.getElementById('diff-rows');
  container.innerHTML='';
  const filtered=lastDiffResults.filter(r=>activeFilters.has(r.type));
  if(!filtered.length){container.innerHTML='<div class="diff-empty">No rows match the active filters.</div>';return;}
  filtered.forEach(r=>{
    const row=document.createElement('div');row.className=`diff-row ${r.type}`;
    const tagText={shared:'Both','only-a':'Only A','only-b':'Only B','qty-diff':'Modified'};
    const cellA=r.a?`<div class="diff-cell-code">${r.a.comp}</div><div class="diff-cell-desc">${r.a.description||'—'}</div><div class="diff-cell-qty">${r.a.qty||'—'} ${r.a.uom||''} • ${r.a.supplier||'—'}</div>`:`<div class="diff-cell-empty" style="display:flex;align-items:center;height:100%;padding:8px 0;color:var(--fg3);font-size:10px;font-style:italic">— not present —</div>`;
    const cellB=r.b?`<div class="diff-cell-code">${r.b.comp}</div><div class="diff-cell-desc">${r.b.description||'—'}</div><div class="diff-cell-qty">${r.b.qty||'—'} ${r.b.uom||''} • ${r.b.supplier||'—'}</div>`:`<div class="diff-cell-empty" style="display:flex;align-items:center;height:100%;padding:8px 0;color:var(--fg3);font-size:10px;font-style:italic">— not present —</div>`;
    row.innerHTML=`<div class="diff-tag"><span>${tagText[r.type]}</span></div><div class="diff-cell">${cellA}</div><div class="diff-cell">${cellB}</div>`;
    container.appendChild(row);
  });
}

function renderCompareSplit(){
  const q=(document.getElementById('search').value||'').toLowerCase().trim();
  const typeMap={same:'shared',del:'only-a',add:'only-b',mod:'qty-diff'};
  const rows=compareRows.filter(r=>{
    const matchesFilter=activeFilters.has(typeMap[r.type]||'shared');
    const matchesSearch=!q || r.comp.toLowerCase().includes(q) || (r.a?.description||'').toLowerCase().includes(q) || (r.b?.description||'').toLowerCase().includes(q);
    return matchesFilter && matchesSearch;
  });
  const left=document.getElementById('cmp-rows-a');
  const right=document.getElementById('cmp-rows-b');
  left.innerHTML='';right.innerHTML='';
  rows.forEach(r=>{
    const cls=r.type==='add'?'cmp-add':r.type==='del'?'cmp-del':r.type==='mod'?'cmp-mod':'cmp-same';
    const status=r.type==='add'?'ADD':r.type==='del'?'DEL':r.type==='mod'?'MOD':'SAME';
    const la=document.createElement('div');la.className=`cmp-row ${cls}`;
    const ra=document.createElement('div');ra.className=`cmp-row ${cls}`;
    la.innerHTML=`<div class="cmp-status">${status}</div><div class="cmp-code">${r.comp}</div><div class="cmp-qty">${r.a?r.a.qty:'—'}</div><div class="cmp-sup">${r.a?(r.a.supplier||'—'):'—'}</div><div class="cmp-desc">${r.a?(r.a.description||'—'):'—'}</div>`;
    ra.innerHTML=`<div class="cmp-status">${status}</div><div class="cmp-code">${r.comp}</div><div class="cmp-qty">${r.b?r.b.qty:'—'}</div><div class="cmp-sup">${r.b?(r.b.supplier||'—'):'—'}</div><div class="cmp-desc">${r.b?(r.b.description||'—'):'—'}</div>`;
    left.appendChild(la);right.appendChild(ra);
  });
}

function toggleChip(el,type){
  el.classList.toggle('on');
  if(el.classList.contains('on')) activeFilters.add(type);
  else activeFilters.delete(type);
  if(lastDiffResults.length){renderDiffRows();renderCompareSplit();}
}

function exportDiff(){
  if(!lastDiffResults.length) return;
  const idxA=document.getElementById('sel-a').value;
  const idxB=document.getElementById('sel-b').value;
  const pool=getComparePool();
  const asmA=pool[idxA];
  const asmB=pool[idxB];

  const lines=[`Status,Part Number,Description A,Qty A,Supplier A,Description B,Qty B,Supplier B,Highlight`];
  lastDiffResults.forEach(r=>{
    const map={shared:'SAME', 'only-a':'DELETION', 'only-b':'ADDITION', 'qty-diff':'MODIFICATION'};
    const hl={shared:'gray', 'only-a':'red', 'only-b':'green', 'qty-diff':'yellow'};
    const esc=v=>`"${String(v??'').replaceAll('"','""')}"`;
    lines.push([
      map[r.type],
      esc(r.comp||''),
      esc(r.a?.description||''),
      esc(r.a?.qty||''),
      esc(r.a?.supplier||''),
      esc(r.b?.description||''),
      esc(r.b?.qty||''),
      esc(r.b?.supplier||''),
      hl[r.type]
    ].join(','));
  });

  const blob=new Blob([lines.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`diff_${asmA.material}_vs_${asmB.material}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  toast('CSV exported');
}

</script>
</body>
</html>
