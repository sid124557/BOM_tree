<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOM Explorer Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
    :root {
        --bg-main: #0a0e1a;
        --bg-panel: #151b2e;
        --bg-card: #1a2235;
        --bg-hover: #242d42;
        --border: #2d3752;
        --border-light: #3d4967;
        --accent: #3b82f6;
        --accent-hover: #2563eb;
        --accent-light: #60a5fa;
        --accent-glow: rgba(59, 130, 246, 0.15);
        --success: #10b981;
        --warning: #f59e0b;
        --text-main: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --guide-line: #2d3752;
        --shadow: rgba(0, 0, 0, 0.3);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, var(--bg-main) 0%, #0f1419 100%);
        color: var(--text-main);
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { 
        background: #475569; 
        border-radius: 4px;
        transition: background 0.2s;
    }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    /* Smooth animations */
    * {
        transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    /* Header */
    header {
        background: linear-gradient(180deg, var(--bg-panel) 0%, rgba(21, 27, 46, 0.95) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px var(--shadow);
        border-bottom: 1px solid var(--border);
    }

    .logo-badge {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    /* Tree Guide Lines */
    .tree-branch {
        position: relative;
        padding-left: 28px;
    }
    .tree-branch::before {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: 13px;
        width: 2px;
        background: linear-gradient(180deg, var(--guide-line) 0%, transparent 100%);
        transition: background 0.3s;
    }
    .tree-branch:last-child::before {
        height: 20px;
    }
    
    .tree-node-wrapper {
        position: relative;
    }
    .tree-node-wrapper::before {
        content: '';
        position: absolute;
        top: 50%;
        left: -15px;
        width: 14px;
        height: 2px;
        background: var(--guide-line);
        border-radius: 2px;
    }
    
    .tree-root > .tree-branch::before { display: none; }
    .tree-root > .tree-branch > .tree-node-wrapper::before { display: none; }

    /* Node Styling */
    .tree-node {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        border-radius: 8px;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border: 2px solid transparent;
        background: rgba(255, 255, 255, 0.02);
        margin-bottom: 4px;
    }
    .tree-node:hover {
        background: var(--bg-hover);
        border-color: var(--border-light);
        transform: translateX(2px);
    }
    .tree-node.active {
        background: var(--accent-glow);
        border-color: var(--accent);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        transform: translateX(4px);
    }
    
    /* Icons */
    .icon-box {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        border-radius: 8px;
        background: var(--bg-card);
        transition: all 0.2s;
    }
    
    .tree-node:hover .icon-box {
        transform: scale(1.1);
    }
    
    .tree-node.active .icon-box {
        background: rgba(59, 130, 246, 0.2);
    }

    /* Search Input */
    .search-wrapper {
        position: relative;
    }
    .search-wrapper input:focus {
        box-shadow: 0 0 0 3px var(--accent-glow);
    }

    /* Button Styles */
    .btn-primary {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        transition: all 0.2s;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }
    .btn-primary:active {
        transform: translateY(0);
    }

    .btn-ghost {
        transition: all 0.2s;
    }
    .btn-ghost:hover {
        background: var(--bg-hover);
        transform: translateY(-1px);
    }

    /* Stats Cards */
    .stat-card {
        background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-panel) 100%);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 20px;
        transition: all 0.3s;
    }
    .stat-card:hover {
        border-color: var(--border-light);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px var(--shadow);
    }

    /* Modal */
    .modal-backdrop {
        background: rgba(10, 14, 26, 0.85);
        backdrop-filter: blur(8px);
        animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal-content {
        animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to { 
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Resizer */
    .resizer {
        width: 1px;
        background: var(--border);
        cursor: col-resize;
        position: relative;
        transition: all 0.2s;
    }
    .resizer:hover {
        background: var(--accent);
        width: 3px;
    }
    .resizer::before {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: -4px;
        right: -4px;
    }

    /* Badge Styles */
    .badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }
    .badge-assembly {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
        color: #fbbf24;
        border: 1px solid rgba(251, 191, 36, 0.3);
    }
    .badge-part {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.2) 100%);
        color: #60a5fa;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    /* Contains Table */
    .contains-table-wrapper {
        border-radius: 12px;
        border: 1px solid var(--border);
        overflow: hidden;
        background: var(--bg-card);
        box-shadow: 0 4px 12px var(--shadow);
    }
    
    .contains-table {
        width: 100%;
        font-size: 0.8rem;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .contains-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--bg-panel);
        box-shadow: 0 2px 8px var(--shadow);
    }
    
    .contains-table th {
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 0.7rem;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        color: var(--text-muted);
        border-bottom: 2px solid var(--border);
        white-space: nowrap;
    }
    
    .contains-table td {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        color: var(--text-secondary);
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.75rem;
    }
    
    .contains-table tbody tr {
        transition: all 0.2s;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.01);
    }
    
    .contains-table tbody tr:hover {
        background: var(--bg-hover);
        transform: scale(1.01);
    }
    
    .contains-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Details Panel */
    .details-header {
        background: linear-gradient(180deg, var(--bg-card) 0%, transparent 100%);
    }

    .tech-data-table {
        background: var(--bg-card);
        border-radius: 10px;
        border: 1px solid var(--border);
        overflow: hidden;
        box-shadow: 0 2px 8px var(--shadow);
    }

    .tech-data-table tr:hover {
        background: var(--bg-hover);
    }

    /* Section Headers */
    .section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--border);
    }

    .section-header svg {
        color: var(--accent);
    }

    /* Empty States */
    .empty-state {
        animation: fadeIn 0.4s ease;
    }

    .empty-state svg {
        opacity: 0.3;
        filter: drop-shadow(0 4px 8px var(--shadow));
    }

    /* Loading Animation */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .loading {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* Tooltip */
    [title] {
        position: relative;
    }

    /* Panel Shadows */
    .panel-shadow {
        box-shadow: 
            0 0 0 1px var(--border),
            0 10px 40px var(--shadow);
    }

    /* Quantity Badge */
    .qty-badge {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        margin-left: 8px;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    /* Search Highlight */
    .search-highlight {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
        color: white;
        padding: 2px 4px;
        border-radius: 4px;
        font-weight: 600;
        box-shadow: 0 0 12px rgba(59, 130, 246, 0.5);
    }

    /* Tree Container */
    .tree-container {
        background: rgba(255, 255, 255, 0.01);
        border-radius: 12px;
        padding: 16px;
    }

    /* Breadcrumbs */
    .breadcrumb-item {
        transition: all 0.2s;
    }
    .breadcrumb-item:hover {
        color: var(--accent-light);
    }

    /* File Upload Area */
    .file-upload {
        transition: all 0.2s;
        border: 2px dashed var(--border);
    }
    .file-upload:hover {
        border-color: var(--accent);
        background: var(--accent-glow);
    }

    /* Stats Bar */
    .stats-bar {
        background: linear-gradient(90deg, var(--bg-card) 0%, var(--bg-panel) 100%);
        border-radius: 8px;
        padding: 8px 16px;
    }

    /* Toggle Arrow Animation */
    .toggle-arrow {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
</style>
</head>
<body>

    <header class="h-16 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-xl logo-badge flex items-center justify-center text-white font-bold text-lg">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                </svg>
            </div>
            <div>
                <h1 class="font-bold text-xl tracking-tight text-white">BOM Explorer</h1>
                <p class="text-xs text-[var(--text-muted)]">Professional Bill of Materials Management</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="search-wrapper relative">
                <input type="text" id="searchInput" placeholder="Search components, descriptions..." 
                    class="bg-[var(--bg-card)] border border-[var(--border)] rounded-lg pl-11 pr-4 py-2.5 text-sm w-80 focus:outline-none focus:border-[var(--accent)] placeholder-[var(--text-muted)]">
                <svg class="w-5 h-5 text-[var(--text-muted)] absolute left-4 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            
            <div class="h-8 w-px bg-[var(--border)]"></div>

            <button onclick="toggleImportModal()" class="btn-primary flex items-center gap-2 px-5 py-2.5 rounded-lg text-white text-sm font-semibold">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                </svg>
                Import Data
            </button>
            <button onclick="exportJSON()" class="btn-ghost p-2.5 text-[var(--text-muted)] hover:text-white rounded-lg" title="Export JSON">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <!-- Tree Panel -->
        <aside class="flex-1 flex flex-col min-w-[320px] max-w-[60%] bg-[var(--bg-panel)] overflow-hidden panel-shadow">
            <div class="stats-bar m-4 flex justify-between items-center text-xs text-[var(--text-muted)]">
                <div class="flex items-center gap-4">
                    <span id="treeStats" class="font-medium">ðŸ“¦ Waiting for data...</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="expandAll()" class="btn-ghost p-2 rounded-lg" title="Expand All">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <button onclick="collapseAll()" class="btn-ghost p-2 rounded-lg" title="Collapse All">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="treeContainer" class="flex-1 overflow-auto px-6 pb-20">
                <div class="empty-state flex flex-col items-center justify-center h-full text-[var(--text-muted)]">
                    <svg class="w-20 h-20 mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    <p class="text-lg font-medium mb-2">No BOM Data Loaded</p>
                    <p class="text-sm opacity-70">Import your bill of materials to get started</p>
                </div>
            </div>
        </aside>

        <div class="resizer"></div>

        <!-- Details Panel -->
        <aside id="detailsPanel" class="w-[480px] bg-[var(--bg-main)] flex flex-col overflow-hidden panel-shadow">
            <div class="empty-state h-full flex flex-col items-center justify-center text-[var(--text-muted)] p-8 text-center" id="emptyDetails">
                <svg class="w-16 h-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p class="text-base font-medium mb-2">Select a Component</p>
                <p class="text-sm opacity-70">Click any item in the tree to view its details</p>
            </div>

            <div id="contentDetails" class="hidden h-full flex flex-col">
                <!-- Breadcrumbs -->
                <div class="px-6 py-4 border-b border-[var(--border)] bg-[var(--bg-panel)]">
                    <div id="breadcrumbs" class="flex items-center text-xs font-mono gap-2 flex-wrap"></div>
                </div>

                <!-- Header -->
                <div class="details-header p-6 border-b border-[var(--border)]">
                    <div class="flex items-start justify-between mb-3">
                        <span id="detailBadge" class="badge badge-part">Component</span>
                        <span id="detailLevel" class="text-xs text-[var(--text-muted)] font-mono bg-[var(--bg-card)] px-3 py-1 rounded-full">Level 3</span>
                    </div>
                    <h2 id="detailName" class="text-3xl font-bold text-white mb-2 font-mono tracking-tight">PART-NAME</h2>
                    <p id="detailDesc" class="text-[var(--text-secondary)] text-sm leading-relaxed">Description goes here</p>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 gap-4 p-6 border-b border-[var(--border)]">
                    <div class="stat-card">
                        <span class="block text-xs text-[var(--text-muted)] uppercase tracking-wider mb-2 font-semibold">Quantity</span>
                        <div class="flex items-baseline gap-2">
                            <span id="detailQty" class="text-2xl font-bold text-[var(--accent)]">0</span>
                            <span id="detailUom" class="text-sm text-[var(--text-muted)] font-mono">EA</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="block text-xs text-[var(--text-muted)] uppercase tracking-wider mb-2 font-semibold">Extended Qty</span>
                        <div class="flex items-baseline gap-2">
                            <span id="detailExtQty" class="text-2xl font-bold text-white">0</span>
                            <span class="text-xs text-[var(--text-muted)] opacity-60">per root</span>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-auto p-6">
                    <!-- Technical Data -->
                    <div class="mb-8">
                        <div class="section-header">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            Technical Data
                        </div>
                        <div class="tech-data-table">
                            <table class="w-full text-sm">
                                <tbody class="divide-y divide-[var(--border)]" id="detailTable"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Contains Section -->
                    <div id="childrenSection" class="hidden">
                        <div class="section-header">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                            </svg>
                            Components
                            <span id="childrenCount" class="text-[var(--text-muted)] font-normal">(0)</span>
                        </div>
                        <div class="contains-table-wrapper" style="max-height: 400px; overflow: auto;">
                            <table class="contains-table">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Description</th>
                                        <th>Plant</th>
                                        <th>Usage</th>
                                        <th>Alt</th>
                                        <th>Base Qty</th>
                                        <th>Component</th>
                                        <th>Comp Desc</th>
                                        <th>Type</th>
                                        <th>Alt Text</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                        <th>Stor Loc</th>
                                    </tr>
                                </thead>
                                <tbody id="childrenTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Footer Actions -->
                <div class="p-4 border-t border-[var(--border)] bg-[var(--bg-panel)]">
                    <button onclick="copyDetailJSON()" class="w-full py-3 rounded-lg border-2 border-[var(--border)] text-sm font-medium text-[var(--text-secondary)] hover:text-white hover:border-[var(--accent)] hover:bg-[var(--accent-glow)] transition-all">
                        <span class="flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            Copy JSON
                        </span>
                    </button>
                </div>
            </div>
        </aside>
    </main>

    <!-- Import Modal -->
    <div id="importModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-6">
        <div class="modal-content bg-[var(--bg-panel)] border border-[var(--border)] rounded-2xl w-full max-w-3xl shadow-2xl overflow-hidden">
            <div class="p-8">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold mb-2">Import BOM Data</h2>
                        <p class="text-sm text-[var(--text-muted)]">Upload or paste your tab-separated bill of materials</p>
                    </div>
                    <button onclick="toggleImportModal()" class="text-[var(--text-muted)] hover:text-white p-2 rounded-lg hover:bg-[var(--bg-hover)]">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="flex gap-4 mb-4">
                        <label class="file-upload flex items-center gap-3 cursor-pointer bg-[var(--bg-card)] px-6 py-3 rounded-xl flex-1 justify-center">
                            <input type="file" id="fileInput" accept=".txt,.csv,.tsv" class="hidden" onchange="handleFileUpload(this)">
                            <svg class="w-5 h-5 text-[var(--accent)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                            </svg>
                            <span class="text-sm font-medium">Choose File</span>
                        </label>
                        <button onclick="loadSample()" class="px-6 py-3 text-sm font-medium text-[var(--accent)] hover:bg-[var(--accent-glow)] rounded-xl border border-[var(--border)]">
                            Load Sample
                        </button>
                    </div>
                </div>

                <textarea id="rawInput" 
                    class="w-full h-80 bg-[var(--bg-card)] border border-[var(--border)] rounded-xl p-6 font-mono text-xs text-[var(--text-secondary)] focus:outline-none focus:border-[var(--accent)] focus:ring-2 focus:ring-[var(--accent-glow)] resize-none" 
                    placeholder="Paste tab-separated BOM data here...

Format: Level | Component | Description | Qty | UoM

Example:
1    ASSY-001    Main Assembly    1    EA
2    PART-100    Component A      2    EA"></textarea>
                
                <div class="mt-6 flex justify-end gap-4">
                    <button onclick="toggleImportModal()" class="px-6 py-3 rounded-lg text-sm font-medium text-[var(--text-muted)] hover:text-white hover:bg-[var(--bg-hover)]">
                        Cancel
                    </button>
                    <button onclick="processData()" class="btn-primary px-8 py-3 rounded-lg text-white text-sm font-bold">
                        Build Tree
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
// --- State Management ---
let rawData = [];
let treeStructure = [];
let flatMap = new Map();
let selectedNodeId = null;

// --- Sample Data ---
const sampleData = `BOM\tLevel\t\t\tComponent\tDescription\tQty\t\tUoM
ASSY-001\t1\t\t\tMAIN-ROBOT-ARM\t6-Axis Robotic Arm Assembly\t1\t\tEA
\tPART-100\t2\t\t\tBASE-FRAME-01\tHeavy Duty Steel Base\t1\t\tEA
\t\tBRKT-101\t3\t\tMNT-BRACKET-A\tL-Shape Mounting Bracket\t4\t\tEA
\t\tFAST-102\t3\t\tSCREW-M4-10\tM4x10 Hex Socket Screw\t16\t\tEA
\t\tWASH-103\t3\t\tWASHER-M4\tM4 Split Lock Washer\t32\t\tEA
\tPART-200\t2\t\t\tACTUATOR-ASSY\tMain Axis Actuator Unit\t1\t\tEA
\t\tMOTR-201\t3\t\tDC-SERVO-12V\tHigh Torque DC Servo\t1\t\tEA
\t\tCABL-202\t3\t\tPOWER-HARNESS\tShielded Power Cable 2m\t1\t\tM
\t\tGEAR-BOX\t3\t\tGEARBOX-20:1\tPlanetary Gearbox Assembly\t1\t\tEA
\t\t\tGEAR-A\t4\t\tSUN-GEAR\tSteel Sun Gear 12T\t1\t\tEA
\t\t\tGEAR-B\t4\t\tPLANET-GEAR\tBrass Planet Gear 24T\t3\t\tEA
\t\t\tRING-C\t4\t\tRING-GEAR\tInternal Ring Gear\t1\t\tEA
\tPART-300\t2\t\t\tELEC-MODULE\tControl Electronics Box\t1\t\tEA
\t\tPCBA-301\t3\t\tMAIN-CONTROLLER\tPCB Assembly v2.4\t1\t\tEA
\t\tIC-302\t4\t\tMCU-ARM-M4\tMicrocontroller Unit\t1\t\tEA
\t\tIC-303\t4\t\tV-REG-5V\tVoltage Regulator 5V\t3\t\tEA
\t\tRES-SET\t4\t\tRESISTOR-KIT\tStandard 0603 Resistors\t1\t\tEA`;

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    toggleImportModal();
});

// --- Modal & Data Handling ---
function toggleImportModal() {
    const modal = document.getElementById('importModal');
    modal.classList.toggle('hidden');
    if (!modal.classList.contains('hidden')) {
        document.getElementById('rawInput').focus();
    }
}

function loadSample() {
    document.getElementById('rawInput').value = sampleData;
}

function handleFileUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('rawInput').value = e.target.result;
    };
    reader.readAsText(file);
}

function processData() {
    const raw = document.getElementById('rawInput').value.trim();
    if (!raw) return alert("Please enter data");

    const lines = raw.split('\n');
    let rows = lines.map(l => l.split('\t'));

    if (rows[0] && (rows[0][1] === 'Level' || isNaN(parseInt(rows[0][1])))) {
        rows.shift();
    }

    rawData = [];
    flatMap.clear();
    
    rows.forEach((r, idx) => {
        const level = parseInt(r[1]);
        if (isNaN(level)) return;

        const id = `node-${idx}`;
        const item = {
            id: id,
            level: level,
            component: r[4] ? r[4].trim() : 'UNKNOWN',
            description: r[5] ? r[5].trim() : '',
            qty: parseFloat(r[6]) || 0,
            uom: r[8] ? r[8].trim() : 'EA',
            children: [],
            parent: null,
            path: [],
            extendedQty: 0,
            material: r[0] ? r[0].trim() : '',
            plant: r[2] ? r[2].trim() : '',
            usage: r[3] ? r[3].trim() : '',
            alternative: '',
            baseQuantity: parseFloat(r[6]) || 0,
            materialType: '',
            altText: '',
            storageLocation: ''
        };
        rawData.push(item);
    });

    const rootNodes = [];
    const levelMap = {};

    rawData.forEach(item => {
        if (item.level === 1) {
            rootNodes.push(item);
            item.extendedQty = item.qty;
        } else {
            const parent = levelMap[item.level - 1];
            if (parent) {
                parent.children.push(item);
                item.parent = parent;
                item.extendedQty = parent.extendedQty * item.qty;
            } else {
                rootNodes.push(item); 
                item.extendedQty = item.qty;
            }
        }
        levelMap[item.level] = item;
        flatMap.set(item.id, item);
    });

    treeStructure = rootNodes;
    
    rawData.forEach(item => {
        let curr = item;
        const path = [];
        while(curr) {
            path.unshift(curr.component);
            curr = curr.parent;
        }
        item.path = path;
    });

    renderTree();
    updateStats();
    toggleImportModal();
    
    document.getElementById('contentDetails').classList.add('hidden');
    document.getElementById('emptyDetails').classList.remove('hidden');
}

// --- Rendering ---
function renderTree() {
    const container = document.getElementById('treeContainer');
    container.innerHTML = '';
    
    const rootUl = document.createElement('div');
    rootUl.className = 'tree-root tree-container';
    
    treeStructure.forEach(node => {
        rootUl.appendChild(createTreeNode(node));
    });
    
    container.appendChild(rootUl);
}

function createTreeNode(node) {
    const wrapper = document.createElement('div');
    wrapper.className = 'tree-branch';
    
    const nodeEl = document.createElement('div');
    nodeEl.className = 'tree-node-wrapper';
    nodeEl.dataset.id = node.id;
    nodeEl.dataset.search = `${node.component.toLowerCase()} ${node.description.toLowerCase()}`;

    const content = document.createElement('div');
    content.className = 'tree-node';
    content.onclick = (e) => {
        e.stopPropagation();
        selectNode(node.id);
        toggleCollapse(wrapper);
    };

    const icon = document.createElement('div');
    icon.className = 'icon-box';
    if (node.children.length > 0) {
        icon.innerHTML = `<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M4 4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2H4z"/></svg>`;
    } else {
        icon.innerHTML = `<svg class="w-5 h-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>`;
    }

    const text = document.createElement('div');
    text.className = 'flex flex-col leading-tight flex-1';
    text.innerHTML = `
        <div class="flex items-center gap-2">
            <span class="font-mono text-sm text-[var(--text-main)] font-semibold node-comp">${node.component}</span>
            ${node.qty > 1 ? `<span class="qty-badge">${node.qty}</span>` : ''}
        </div>
        <span class="text-xs text-[var(--text-muted)] truncate max-w-[220px]">${node.description}</span>
    `;

    const toggle = document.createElement('div');
    toggle.className = 'ml-auto pl-3 text-[var(--text-muted)] toggle-arrow';
    if (node.children.length > 0) {
        toggle.innerHTML = `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"/></svg>`;
        wrapper.classList.add('has-children');
        wrapper.dataset.expanded = 'true';
    }

    content.appendChild(icon);
    content.appendChild(text);
    if(node.children.length > 0) content.appendChild(toggle);
    
    nodeEl.appendChild(content);
    wrapper.appendChild(nodeEl);

    if (node.children.length > 0) {
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'tree-children';
        node.children.forEach(child => {
            childrenContainer.appendChild(createTreeNode(child));
        });
        wrapper.appendChild(childrenContainer);
    }

    return wrapper;
}

// --- Interaction ---
function selectNode(id) {
    document.querySelectorAll('.tree-node.active').forEach(el => el.classList.remove('active'));
    
    const nodeEl = document.querySelector(`.tree-node-wrapper[data-id="${id}"] > .tree-node`);
    if(nodeEl) nodeEl.classList.add('active');

    selectedNodeId = id;
    const data = flatMap.get(id);
    updateDetails(data);
}

function toggleCollapse(wrapper) {
    if (!wrapper.classList.contains('has-children')) return;
    
    const children = wrapper.querySelector('.tree-children');
    const toggle = wrapper.querySelector('.toggle-arrow');
    
    if (wrapper.dataset.expanded === 'true') {
        children.style.display = 'none';
        wrapper.dataset.expanded = 'false';
        if(toggle) toggle.style.transform = 'rotate(-90deg)';
    } else {
        children.style.display = 'block';
        wrapper.dataset.expanded = 'true';
        if(toggle) toggle.style.transform = 'rotate(0deg)';
    }
}

function updateDetails(data) {
    document.getElementById('emptyDetails').classList.add('hidden');
    document.getElementById('contentDetails').classList.remove('hidden');

    const crumbs = document.getElementById('breadcrumbs');
    crumbs.innerHTML = data.path.map((p, i) => 
        `<span class="breadcrumb-item ${i === data.path.length-1 ? 'text-white font-semibold' : 'text-[var(--text-muted)]'}">${p}</span>`
    ).join('<span class="mx-2 text-[var(--border)]">â†’</span>');

    document.getElementById('detailName').textContent = data.component;
    document.getElementById('detailDesc').textContent = data.description || 'No description available';
    document.getElementById('detailLevel').textContent = `Level ${data.level}`;
    
    const badge = document.getElementById('detailBadge');
    if (data.children.length > 0) {
        badge.textContent = 'ðŸ“¦ Assembly';
        badge.className = 'badge badge-assembly';
    } else {
        badge.textContent = 'ðŸ”© Part';
        badge.className = 'badge badge-part';
    }

    document.getElementById('detailQty').textContent = data.qty;
    document.getElementById('detailExtQty').textContent = data.extendedQty;
    document.getElementById('detailUom').textContent = data.uom;

    const tbody = document.getElementById('detailTable');
    tbody.innerHTML = `
        <tr><td class="p-4 text-[var(--text-muted)] w-1/3 font-medium">Component ID</td><td class="p-4 text-white font-mono">${data.component}</td></tr>
        <tr><td class="p-4 text-[var(--text-muted)] font-medium">Description</td><td class="p-4 text-white">${data.description}</td></tr>
        <tr><td class="p-4 text-[var(--text-muted)] font-medium">Unit of Measure</td><td class="p-4 text-white font-mono">${data.uom}</td></tr>
        <tr><td class="p-4 text-[var(--text-muted)] font-medium">Tree Level</td><td class="p-4 text-white">${data.level}</td></tr>
        <tr><td class="p-4 text-[var(--text-muted)] font-medium">Child Count</td><td class="p-4 text-white">${data.children.length}</td></tr>
    `;
    
    const childrenSection = document.getElementById('childrenSection');
    const childrenTableBody = document.getElementById('childrenTableBody');
    const childrenCount = document.getElementById('childrenCount');
    
    if (data.children.length > 0) {
        childrenSection.classList.remove('hidden');
        childrenCount.textContent = `(${data.children.length})`;
        
        childrenTableBody.innerHTML = data.children.map(c => `
            <tr onclick="selectNode('${c.id}')">
                <td>${c.material || 'â€”'}</td>
                <td>${c.description || 'â€”'}</td>
                <td>${c.plant || 'â€”'}</td>
                <td>${c.usage || 'â€”'}</td>
                <td>${c.alternative || 'â€”'}</td>
                <td>${c.baseQuantity || 'â€”'}</td>
                <td class="font-semibold text-[var(--accent-light)]">${c.component}</td>
                <td>${c.description || 'â€”'}</td>
                <td>${c.materialType || 'â€”'}</td>
                <td>${c.altText || 'â€”'}</td>
                <td class="font-semibold">${c.qty}</td>
                <td>${c.uom}</td>
                <td>${c.storageLocation || 'â€”'}</td>
            </tr>
        `).join('');
    } else {
        childrenSection.classList.add('hidden');
    }
}

function updateStats() {
    const total = rawData.length;
    const assemblies = rawData.filter(i => i.children.length > 0).length;
    document.getElementById('treeStats').textContent = `ðŸ“¦ ${total} Items â€¢ ðŸ”§ ${assemblies} Assemblies â€¢ ðŸ”© ${total - assemblies} Parts`;
}

function expandAll() {
    document.querySelectorAll('.tree-branch.has-children').forEach(el => {
        el.dataset.expanded = 'true';
        el.querySelector('.tree-children').style.display = 'block';
        const toggle = el.querySelector('.toggle-arrow');
        if(toggle) toggle.style.transform = 'rotate(0deg)';
    });
}

function collapseAll() {
    document.querySelectorAll('.tree-branch.has-children').forEach(el => {
        el.dataset.expanded = 'false';
        el.querySelector('.tree-children').style.display = 'none';
        const toggle = el.querySelector('.toggle-arrow');
        if(toggle) toggle.style.transform = 'rotate(-90deg)';
    });
}

// --- Search / Filter ---
document.getElementById('searchInput').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase().trim();
    const wrappers = document.querySelectorAll('.tree-branch');
    const nodes = document.querySelectorAll('.tree-node-wrapper');

    if (!term) {
        wrappers.forEach(w => w.style.display = '');
        document.querySelectorAll('.node-comp').forEach(el => {
            const id = el.closest('.tree-node-wrapper').dataset.id;
            el.textContent = flatMap.get(id).component;
        });
        return;
    }

    const matches = new Set();
    nodes.forEach(n => {
        if (n.dataset.search.includes(term)) {
            matches.add(n.dataset.id);
            const compSpan = n.querySelector('.node-comp');
            const original = flatMap.get(n.dataset.id).component;
            const regex = new RegExp(`(${term})`, 'gi');
            compSpan.innerHTML = original.replace(regex, '<span class="search-highlight">$1</span>');
        } else {
            const compSpan = n.querySelector('.node-comp');
            compSpan.textContent = flatMap.get(n.dataset.id).component;
        }
    });

    wrappers.forEach(w => w.style.display = 'none');

    matches.forEach(id => {
        let curr = flatMap.get(id);
        
        const selfWrapper = document.querySelector(`.tree-node-wrapper[data-id="${id}"]`).parentElement;
        selfWrapper.style.display = '';
        
        while(curr) {
            const nodeEl = document.querySelector(`.tree-node-wrapper[data-id="${curr.id}"]`);
            if (nodeEl) {
                const w = nodeEl.parentElement;
                w.style.display = '';
                
                if (w.classList.contains('has-children')) {
                   w.dataset.expanded = 'true';
                   w.querySelector('.tree-children').style.display = 'block';
                }
            }
            curr = curr.parent;
        }
    });
});

// --- Export ---
function exportJSON() {
    if (treeStructure.length === 0) return alert("No data to export");
    
    const clean = (nodes) => {
        return nodes.map(n => ({
            level: n.level,
            component: n.component,
            description: n.description,
            qty: n.qty,
            uom: n.uom,
            children: clean(n.children)
        }));
    };
    
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(clean(treeStructure), null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "bom_export.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

function copyDetailJSON() {
    if (!selectedNodeId) return;
    const n = flatMap.get(selectedNodeId);
    const obj = {
        component: n.component,
        description: n.description,
        qty: n.qty,
        extendedQty: n.extendedQty,
        level: n.level
    };
    navigator.clipboard.writeText(JSON.stringify(obj, null, 2));
    const btn = event.target.closest('button');
    const oldText = btn.innerHTML;
    btn.innerHTML = `<span class="flex items-center justify-center gap-2">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        Copied!
    </span>`;
    btn.classList.add('border-[var(--success)]', 'text-[var(--success)]');
    setTimeout(() => {
        btn.innerHTML = oldText;
        btn.classList.remove('border-[var(--success)]', 'text-[var(--success)]');
    }, 2000);
}
</script>
</body>
</html>
