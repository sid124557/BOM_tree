<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOM Tree Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Syne:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#07090f; --panel:#0d1117; --card:#111822; --hover:#161f2e;
  --fg:#e2eaf5; --fg2:#8a9ab8; --fg3:#3d4f68;
  --accent:#00c896; --accent-bg:rgba(0,200,150,.1); --accent-bd:rgba(0,200,150,.3);
  --bd:rgba(255,255,255,.06); --bd2:rgba(255,255,255,.1);
  --l1:#00c896; --l1b:rgba(0,200,150,.14);
  --l2:#3b82f6; --l2b:rgba(59,130,246,.14);
  --l3:#a78bfa; --l3b:rgba(167,139,250,.14);
  --l4:#f59e0b; --l4b:rgba(245,158,11,.14);
  --l5:#ec4899; --l5b:rgba(236,72,153,.14);
  --l6:#64748b; --l6b:rgba(100,116,139,.14);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Syne',sans-serif;background:var(--bg);color:var(--fg);min-height:100vh;display:grid;grid-template-columns:320px 1fr;height:100vh;overflow:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,200,150,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,200,150,.025) 1px,transparent 1px);background-size:36px 36px;pointer-events:none;z-index:0;}

/* SIDEBAR */
.sidebar{position:relative;z-index:1;background:var(--panel);border-right:1px solid var(--bd2);display:flex;flex-direction:column;overflow:hidden;}
.sb-head{padding:20px 20px 14px;border-bottom:1px solid var(--bd);flex-shrink:0;}
.logo{display:flex;align-items:center;gap:9px;margin-bottom:4px;}
.logo-box{width:28px;height:28px;background:var(--accent);border-radius:5px;display:grid;place-items:center;flex-shrink:0;}
.logo-box svg{color:#000;}
h1{font-size:17px;font-weight:800;letter-spacing:-.02em;}
h1 span{color:var(--accent);}
.sb-sub{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--fg3);letter-spacing:.06em;text-transform:uppercase;}

.sb-input{padding:14px 16px;border-bottom:1px solid var(--bd);flex-shrink:0;}
.inp-label{font-size:9px;font-weight:700;color:var(--fg3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;}
.mono-tag{font-family:'IBM Plex Mono',monospace;font-size:8px;background:rgba(255,255,255,.05);padding:2px 5px;border-radius:3px;}
textarea{width:100%;min-height:110px;background:rgba(0,0,0,.4);border:1px solid var(--bd2);border-radius:7px;color:var(--fg);font-family:'IBM Plex Mono',monospace;font-size:10px;line-height:1.6;padding:9px 11px;resize:vertical;transition:border-color .2s,box-shadow .2s;}
textarea:focus{outline:none;border-color:var(--accent-bd);box-shadow:0 0 0 3px var(--accent-bg);}
textarea::placeholder{color:var(--fg3);}
.btn-row{display:flex;gap:6px;margin-top:9px;}
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 12px;border-radius:5px;font-family:'Syne',sans-serif;font-weight:700;font-size:11px;cursor:pointer;transition:all .15s;border:none;white-space:nowrap;}
.btn-p{background:var(--accent);color:#000;flex:1;}
.btn-p:hover{background:#00dfb8;transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,200,150,.35);}
.btn-g{background:rgba(255,255,255,.05);color:var(--fg2);border:1px solid var(--bd2);}
.btn-g:hover{background:rgba(255,255,255,.09);color:var(--fg);}

.sb-nav{flex:1;overflow-y:auto;padding:10px 12px;}
.nav-title{font-size:9px;font-weight:700;color:var(--fg3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;padding:0 4px;}
.nav-empty{text-align:center;padding:24px 10px;color:var(--fg3);font-size:11px;}
.nav-item{display:flex;align-items:center;gap:8px;padding:8px 9px;border-radius:6px;cursor:pointer;transition:all .15s;margin-bottom:2px;border:1px solid transparent;}
.nav-item:hover{background:var(--hover);}
.nav-item.active{background:var(--accent-bg);border-color:var(--accent-bd);}
.nav-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.nav-info{flex:1;min-width:0;}
.nav-code{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.nav-desc{font-size:10px;color:var(--fg2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;}
.nav-badge{font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;flex-shrink:0;}

.sb-stats{border-top:1px solid var(--bd);display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--bd);flex-shrink:0;}
.stat-cell{background:var(--panel);padding:9px 5px;text-align:center;}
.stat-n{font-family:'IBM Plex Mono',monospace;font-size:18px;font-weight:600;color:var(--accent);line-height:1;}
.stat-k{font-size:8px;color:var(--fg3);text-transform:uppercase;letter-spacing:.07em;margin-top:2px;}

/* MAIN */
.main{position:relative;z-index:1;display:flex;flex-direction:column;overflow:hidden;}
.main-hdr{padding:18px 26px 12px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;flex-shrink:0;}
.main-title-wrap{flex:1;min-width:0;}
.main-eyebrow{font-size:9px;font-weight:700;color:var(--fg3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:3px;}
.main-asm-name{font-size:19px;font-weight:800;letter-spacing:-.02em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.main-asm-code{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--fg2);margin-top:2px;}
.ctrls{display:flex;align-items:center;gap:6px;}
.sw{position:relative;}
.sw svg{position:absolute;left:8px;top:50%;transform:translateY(-50%);color:var(--fg3);pointer-events:none;}
.search{background:rgba(0,0,0,.4);border:1px solid var(--bd2);border-radius:6px;padding:7px 10px 7px 28px;color:var(--fg);font-family:'IBM Plex Mono',monospace;font-size:11px;width:190px;transition:all .2s;}
.search:focus{outline:none;border-color:var(--accent-bd);box-shadow:0 0 0 3px var(--accent-bg);width:230px;}
.ic-btn{width:30px;height:30px;display:grid;place-items:center;background:rgba(255,255,255,.04);border:1px solid var(--bd2);border-radius:5px;color:var(--fg3);cursor:pointer;transition:all .15s;}
.ic-btn:hover{color:var(--fg);background:rgba(255,255,255,.08);}

.tree-area{flex:1;overflow-y:auto;padding:18px 26px;}

/* ASSEMBLY BLOCK */
.asm-block{margin-bottom:18px;border:1px solid var(--bd2);border-radius:9px;overflow:hidden;background:var(--card);}
.asm-bar{display:flex;align-items:center;gap:11px;padding:12px 15px;cursor:pointer;border-bottom:1px solid var(--bd);transition:background .15s;user-select:none;}
.asm-bar:hover{background:var(--hover);}
.asm-accent{width:3px;height:32px;border-radius:2px;flex-shrink:0;}
.asm-bar-info{flex:1;min-width:0;}
.asm-bar-code{font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:600;}
.asm-bar-desc{font-size:11px;color:var(--fg2);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.asm-meta{display:flex;align-items:center;gap:7px;flex-shrink:0;}
.asm-cnt{font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:700;padding:3px 8px;border-radius:4px;}
.asm-chev{transition:transform .25s;color:var(--fg3);}

/* COLUMN HEADER */
.col-hdr{display:grid;gap:6px;padding:6px 15px;background:rgba(0,0,0,.35);border-bottom:1px solid var(--bd);}
.col-hdr span{font-size:8px;font-weight:700;color:var(--fg3);text-transform:uppercase;letter-spacing:.1em;font-family:'IBM Plex Mono',monospace;}

/* 7-col grid: toggle | level | component | description | qty | uom | copy */
.rg{display:grid;grid-template-columns:18px 56px 1fr 1.4fr 76px 48px 24px;gap:6px;align-items:center;}

.parts-body{overflow:hidden;max-height:0;transition:max-height .3s cubic-bezier(.4,0,.2,1);}
.parts-body.open{max-height:999999px;}

/* PART ROW */
.part-wrap{border-bottom:1px solid var(--bd);}
.part-wrap:last-child{border-bottom:none;}
.part-row{padding:7px 15px;cursor:pointer;transition:background .12s;user-select:none;}
.part-row:hover{background:var(--hover);}
.part-row.match{background:rgba(0,200,150,.07);outline:1px solid var(--accent-bd);outline-offset:-1px;}

.ptog{display:grid;place-items:center;color:var(--fg3);}
.ptog svg{transition:transform .2s;}
.ptog.open svg{transform:rotate(90deg);}
.ptog.leaf{opacity:.18;pointer-events:none;}

.lbadge{font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:700;padding:2px 5px;border-radius:3px;text-align:center;}
.lbadge.l1{background:var(--l1b);color:var(--l1);}
.lbadge.l2{background:var(--l2b);color:var(--l2);}
.lbadge.l3{background:var(--l3b);color:var(--l3);}
.lbadge.l4{background:var(--l4b);color:var(--l4);}
.lbadge.l5{background:var(--l5b);color:var(--l5);}
.lbadge.l6{background:var(--l6b);color:var(--l6);}

.pcode{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pdesc{font-size:11px;color:var(--fg2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pqty{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--accent);font-weight:600;text-align:right;}
.puom{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--fg3);text-align:center;}

.copy-btn{opacity:0;width:22px;height:22px;display:grid;place-items:center;background:transparent;border:none;border-radius:3px;color:var(--fg3);cursor:pointer;transition:all .15s;}
.part-row:hover .copy-btn{opacity:1;}
.copy-btn:hover{background:var(--accent-bg);color:var(--accent);}

/* CHILDREN INDENT */
.child-wrap{overflow:hidden;max-height:0;transition:max-height .28s cubic-bezier(.4,0,.2,1);border-left:2px solid var(--bd2);margin-left:26px;background:rgba(0,0,0,.1);}
.child-wrap.open{max-height:999999px;}

/* EMPTY */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:70px 24px;gap:12px;color:var(--fg3);text-align:center;}
.empty-ring{width:52px;height:52px;border:2px dashed rgba(255,255,255,.08);border-radius:12px;display:grid;place-items:center;}
.empty-title{font-size:14px;font-weight:700;color:var(--fg2);}
.empty-desc{font-size:12px;line-height:1.65;max-width:380px;}

/* TOAST */
.toast{position:fixed;bottom:16px;right:16px;background:var(--card);border:1px solid var(--accent-bd);color:var(--fg);padding:8px 13px;border-radius:6px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:7px;opacity:0;transform:translateY(10px);transition:all .2s;z-index:999;pointer-events:none;}
.toast.on{opacity:1;transform:translateY(0);}

::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.07);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.13);}

@media(max-width:860px){body{grid-template-columns:1fr;height:auto;overflow:auto;}.sidebar{height:auto;max-height:none;}.main{height:auto;}.tree-area{overflow:visible;}}
</style>
</head>
<body>

<aside class="sidebar">
  <div class="sb-head">
    <div class="logo">
      <div class="logo-box">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
          <rect x="3" y="14" width="7" height="7" rx="1"/><line x1="17.5" y1="10.5" x2="17.5" y2="14"/>
          <line x1="14" y1="17.5" x2="17.5" y2="17.5"/><line x1="21" y1="17.5" x2="17.5" y2="17.5"/>
        </svg>
      </div>
      <h1>BOM <span>Viewer</span></h1>
    </div>
    <div class="sb-sub">Bill of Materials — Interactive Tree</div>
  </div>

  <div class="sb-input">
    <div class="inp-label">
      <span>Paste BOM Data</span>
      <span class="mono-tag">tab-separated</span>
    </div>
    <textarea id="raw" placeholder="Paste SAP BOM export here...&#10;&#10;Expected columns:&#10;Plant | Level | Material | Material Description&#10;| Component | Component Description | Qty | Qty(BUn) | UOM | ..."></textarea>
    <div class="btn-row">
      <button class="btn btn-p" onclick="go()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        Generate
      </button>
      <button class="btn btn-g" onclick="loadSample()">Sample</button>
      <button class="btn btn-g" onclick="clearAll()">Clear</button>
    </div>
  </div>

  <div class="sb-nav">
    <div class="nav-title">Assemblies</div>
    <div id="nav-list"><div class="nav-empty">No data loaded yet</div></div>
  </div>

  <div class="sb-stats" id="sb-stats" style="display:none">
    <div class="stat-cell"><div class="stat-n" id="s-asm">0</div><div class="stat-k">Assemblies</div></div>
    <div class="stat-cell"><div class="stat-n" id="s-rows">0</div><div class="stat-k">Total Rows</div></div>
    <div class="stat-cell"><div class="stat-n" id="s-max">0</div><div class="stat-k">Max Depth</div></div>
  </div>
</aside>

<div class="main">
  <div class="main-hdr">
    <div class="main-title-wrap">
      <div class="main-eyebrow">Viewing</div>
      <div class="main-asm-name" id="hdr-name" style="color:var(--fg3)">No assembly selected</div>
      <div class="main-asm-code" id="hdr-code">Load data to begin</div>
    </div>
    <div class="ctrls">
      <div class="sw">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input class="search" id="search" type="text" placeholder="Search components…" oninput="doSearch(this.value)">
      </div>
      <button class="ic-btn" title="Expand all" onclick="expandAll()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
      </button>
      <button class="ic-btn" title="Collapse all" onclick="collapseAll()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" y1="10" x2="21" y2="3"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
      </button>
    </div>
  </div>

  <div class="tree-area" id="tree">
    <div class="empty">
      <div class="empty-ring"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg></div>
      <div class="empty-title">No BOM data loaded</div>
      <div class="empty-desc">Paste your SAP BOM export and click Generate.<br><br>Each unique <strong>Material</strong> (col 3) becomes its own collapsible assembly block. The <strong>Level</strong> column (col 2) drives the hierarchy depth.</div>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
  <span id="toast-msg">Copied</span>
</div>

<script>
/* ─── PALETTE ─── */
const COLORS=['#00c896','#3b82f6','#a78bfa','#f59e0b','#ec4899','#10b981','#f97316','#06b6d4','#84cc16','#e879f9'];

/* ─── STATE ─── */
let assemblies=[];

/* ════════════════════════════════════════════
   PARSE
   Tab-separated SAP BOM format:
   col0=Plant  col1=Level  col2=Material  col3=MatDesc
   col4=Component  col5=CompDesc  col6=Qty  col7=QtyBUn  col8=UOM
════════════════════════════════════════════ */
function parseData(raw){
  const lines=raw.trim().split('\n');
  let start=0;
  // skip header row if present
  const h=lines[0].split('\t');
  if(h[1]==='Level'||h[2]==='Material'||isNaN(parseInt(h[1]))){start=1;}

  const asmMap=new Map(); // material → asm object
  let colorIdx=0;

  for(let i=start;i<lines.length;i++){
    const c=lines[i].split('\t');
    if(c.length<6) continue;

    const level    =parseInt((c[1]||'').trim());
    const material =(c[2]||'').trim();
    const matDesc  =(c[3]||'').trim();
    const component=(c[4]||'').trim();
    const compDesc =(c[5]||'').trim();
    const qty      =(c[6]||'').trim().replace(/,/g,'');
    const uom      =(c[8]||'').trim();

    if(isNaN(level)||!material||!component) continue;

    if(!asmMap.has(material)){
      asmMap.set(material,{
        material, description:matDesc,
        color:COLORS[colorIdx%COLORS.length],
        rows:[]
      });
      colorIdx++;
    }
    const asm=asmMap.get(material);
    if(!asm.description&&matDesc) asm.description=matDesc;
    asm.rows.push({level,component,description:compDesc,qty,uom,id:uid()});
  }

  return [...asmMap.values()];
}

/* ════════════════════════════════════════════
   BUILD HIERARCHY
   Key rule: after placing a node at level N,
   clear all stack entries > N so the next node
   at the same level doesn't get parented to a
   sibling's deeper chain.
════════════════════════════════════════════ */
function buildTree(rows){
  const nodes=rows.map(r=>({...r,children:[],hasChildren:false}));
  const roots=[];
  const stack={};  // level → last node placed there

  for(const node of nodes){
    let parent=null;
    for(let l=node.level-1;l>=1;l--){
      if(stack[l]){parent=stack[l];break;}
    }
    if(parent){parent.children.push(node);parent.hasChildren=true;}
    else{roots.push(node);}
    stack[node.level]=node;
    // prune deeper levels
    Object.keys(stack).forEach(k=>{if(+k>node.level)delete stack[k];});
  }
  return roots;
}

/* ─── ENTRY POINT ─── */
function go(){
  const raw=document.getElementById('raw').value;
  if(!raw.trim()){toast('No data entered');return;}
  assemblies=parseData(raw);
  if(!assemblies.length){toast('Could not parse any assemblies');return;}
  assemblies.forEach(a=>{a.tree=buildTree(a.rows);});
  renderNav();
  renderAll();
  updateStats();
}

/* ─── NAV ─── */
function renderNav(){
  const el=document.getElementById('nav-list');
  el.innerHTML='';
  assemblies.forEach((asm,idx)=>{
    const total=countNodes(asm.tree);
    const item=document.createElement('div');
    item.className='nav-item';
    item.dataset.idx=idx;
    item.innerHTML=`
      <div class="nav-dot" style="background:${asm.color}"></div>
      <div class="nav-info">
        <div class="nav-code">${asm.material}</div>
        <div class="nav-desc">${asm.description||'—'}</div>
      </div>
      <span class="nav-badge" style="background:${asm.color}22;color:${asm.color}">${total}</span>`;
    item.onclick=()=>{
      document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
      item.classList.add('active');
      const block=document.querySelector(`[data-asm="${idx}"]`);
      if(block) block.scrollIntoView({behavior:'smooth',block:'start'});
    };
    el.appendChild(item);
  });
}

function countNodes(nodes){
  let n=0;
  nodes.forEach(nd=>{n++;n+=countNodes(nd.children);});
  return n;
}

/* ─── RENDER ALL ─── */
function renderAll(){
  const area=document.getElementById('tree');
  area.innerHTML='';
  if(assemblies.length===1){
    setHeader(assemblies[0].material,assemblies[0].description,assemblies[0].color);
  }else{
    setHeader(`${assemblies.length} Assemblies`,'All assemblies shown below','var(--accent)');
  }
  assemblies.forEach((asm,idx)=>area.appendChild(makeAsmBlock(asm,idx)));
}

function setHeader(name,code,color){
  document.getElementById('hdr-name').textContent=name;
  document.getElementById('hdr-name').style.color=color;
  document.getElementById('hdr-code').textContent=code||'';
}

/* ─── ASSEMBLY BLOCK ─── */
function makeAsmBlock(asm,idx){
  const total=countNodes(asm.tree);
  const block=document.createElement('div');
  block.className='asm-block';
  block.dataset.asm=idx;
  block.style.cssText=`border-top:2px solid ${asm.color};`;

  const bar=document.createElement('div');
  bar.className='asm-bar';
  bar.innerHTML=`
    <div class="asm-accent" style="background:${asm.color}"></div>
    <div class="asm-bar-info">
      <div class="asm-bar-code">${asm.material}</div>
      <div class="asm-bar-desc">${asm.description||'No description'}</div>
    </div>
    <div class="asm-meta">
      <span class="asm-cnt" style="background:${asm.color}1a;color:${asm.color}">${total} parts</span>
      <svg class="asm-chev" style="transform:rotate(90deg)" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
    </div>`;

  const colHdr=document.createElement('div');
  colHdr.className='col-hdr rg';
  colHdr.innerHTML=`<span></span><span>Level</span><span>Component</span><span>Description</span><span style="text-align:right">Qty</span><span style="text-align:center">UoM</span><span></span>`;

  const body=document.createElement('div');
  body.className='parts-body open';
  body.appendChild(colHdr);

  const partsDiv=document.createElement('div');
  asm.tree.forEach(nd=>partsDiv.appendChild(makePartWrap(nd,asm.color)));
  body.appendChild(partsDiv);

  bar.onclick=()=>{
    const open=body.classList.toggle('open');
    bar.querySelector('.asm-chev').style.transform=open?'rotate(90deg)':'rotate(0)';
  };

  block.appendChild(bar);
  block.appendChild(body);
  return block;
}

/* ─── PART ROW (recursive) ─── */
function makePartWrap(node,asmColor){
  const wrap=document.createElement('div');
  wrap.className='part-wrap';
  wrap.dataset.comp=(node.component||'').toLowerCase();
  wrap.dataset.desc=(node.description||'').toLowerCase();
  wrap.dataset.nodeId=node.id;

  const lvCls=`l${Math.min(node.level,6)}`;

  const row=document.createElement('div');
  row.className='part-row rg';

  const tog=document.createElement('div');
  tog.className=`ptog${node.hasChildren?'':' leaf'}`;
  tog.innerHTML=`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>`;

  const lv=mk('span',`lbadge ${lvCls}`,`L${node.level}`);
  const code=mk('div','pcode',node.component);
  code.title=node.component;
  const desc=mk('div','pdesc',node.description||'—');
  desc.title=node.description;
  const qty=mk('div','pqty',node.qty||'—');
  const uom=mk('div','puom',node.uom||'—');

  const copyBtn=document.createElement('button');
  copyBtn.className='copy-btn';
  copyBtn.title='Copy row';
  copyBtn.innerHTML=`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;
  copyBtn.onclick=e=>{e.stopPropagation();navigator.clipboard.writeText(`${node.component}\t${node.description}\t${node.qty}\t${node.uom}`);toast('Row copied');};

  [tog,lv,code,desc,qty,uom,copyBtn].forEach(c=>row.appendChild(c));
  wrap.appendChild(row);

  if(node.hasChildren){
    const cw=document.createElement('div');
    cw.className='child-wrap';
    cw.style.borderLeftColor=asmColor+'55';
    node.children.forEach(child=>cw.appendChild(makePartWrap(child,asmColor)));
    wrap.appendChild(cw);
    row.onclick=e=>{
      if(e.target.closest('.copy-btn')) return;
      const open=cw.classList.toggle('open');
      tog.classList.toggle('open',open);
    };
  }
  return wrap;
}

function mk(tag,cls,text){const e=document.createElement(tag);e.className=cls;e.textContent=text;return e;}

/* ─── STATS ─── */
function updateStats(){
  let totalRows=0,maxD=0;
  assemblies.forEach(a=>{totalRows+=a.rows.length;a.rows.forEach(r=>{maxD=Math.max(maxD,r.level);});});
  document.getElementById('s-asm').textContent=assemblies.length;
  document.getElementById('s-rows').textContent=totalRows;
  document.getElementById('s-max').textContent=maxD;
  document.getElementById('sb-stats').style.display='grid';
}

/* ─── SEARCH ─── */
function doSearch(q){
  const ql=q.toLowerCase().trim();
  document.querySelectorAll('.part-wrap').forEach(wrap=>{
    const row=wrap.querySelector('.part-row');
    const hit=ql&&((wrap.dataset.comp||'').includes(ql)||(wrap.dataset.desc||'').includes(ql));
    row.classList.toggle('match',!!hit);
    if(hit){
      let p=wrap.parentElement;
      while(p){
        if(p.classList.contains('child-wrap')){
          p.classList.add('open');
          const prev=p.previousElementSibling;
          if(prev) prev.querySelector('.ptog')?.classList.add('open');
        }
        if(p.classList.contains('parts-body')) p.classList.add('open');
        p=p.parentElement;
      }
    }
  });
}

/* ─── EXPAND / COLLAPSE ─── */
function expandAll(){
  document.querySelectorAll('.child-wrap').forEach(e=>e.classList.add('open'));
  document.querySelectorAll('.ptog:not(.leaf)').forEach(e=>e.classList.add('open'));
  document.querySelectorAll('.parts-body').forEach(e=>e.classList.add('open'));
  document.querySelectorAll('.asm-chev').forEach(e=>e.style.transform='rotate(90deg)');
}
function collapseAll(){
  document.querySelectorAll('.child-wrap').forEach(e=>e.classList.remove('open'));
  document.querySelectorAll('.ptog').forEach(e=>e.classList.remove('open'));
  document.querySelectorAll('.parts-body').forEach(e=>e.classList.remove('open'));
  document.querySelectorAll('.asm-chev').forEach(e=>e.style.transform='rotate(0deg)');
}

/* ─── HELPERS ─── */
function uid(){return Math.random().toString(36).slice(2,9);}
function toast(msg){
  const t=document.getElementById('toast');
  document.getElementById('toast-msg').textContent=msg;
  t.classList.add('on');
  clearTimeout(t._t);
  t._t=setTimeout(()=>t.classList.remove('on'),2200);
}
function clearAll(){
  document.getElementById('raw').value='';
  assemblies=[];
  document.getElementById('tree').innerHTML=`<div class="empty"><div class="empty-ring"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg></div><div class="empty-title">No BOM data loaded</div><div class="empty-desc">Paste your data and click Generate.</div></div>`;
  document.getElementById('nav-list').innerHTML='<div class="nav-empty">No data loaded yet</div>';
  document.getElementById('sb-stats').style.display='none';
  setHeader('No assembly selected','Load data to begin','var(--fg3)');
}

/* ─── SAMPLE (matches real format) ─── */
const SAMPLE=`Plant\tLevel\tMaterial\tMaterial Description\tComponent\tComponent Description\tComp. Qty(CUn)\tComp. Qty(BUn)\tUOM\tMaterial Type
5600\t1\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO00100587\tSIKAMELT-700\t39\t39\tKG\tROH
5600\t1\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tS3670155F3\tHSG ASM-HL-CONDOR-RHD-RH-24V\t1\t1\tNO\tHALB
5600\t2\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO01610254\tSEALING RING\t1\t1\tNO\tROH
5600\t2\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO07100006\tGEAR ASM-ADJUSTER-HORIZONTAL\t1\t1\tNO\tROH
5600\t2\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tS3670155F2\tREF ASSY-HL-CONDOR-RHD-RH-24V\t1\t1\tNO\tHALB
5600\t3\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO02907174\tPIVOT BUSH\t1\t1\tNO\tROH
5600\t3\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO01610404\tSCREW 5X DELT PT50\t1\t1\tNO\tROH
5600\t3\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tS367015516\tREF-HL-LD-CONDOR-RHD-RH\t1\t1\tNO\tHALB
5600\t4\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tS367015514\tREF-HL-LD-CONDOR-RHD-RH-2W\t1\t1\tNO\tHALB
5600\t5\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO02801409\tBASECOAT MATERIAL\t19\t19\tG\tROH
5600\t5\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO02801400\tSOLVENT BASECOAT-BUTYL ACETATE\t28\t28\tL\tROH
5600\t6\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tRM01220116\tBMC 3100 7250-10A 109 LD\t617\t617\tKG\tROH
5600\t1\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tS3670155F1\tLENS ASSEMBLY-HL-CONDO-RH\t1\t1\tNO\tHALB
5600\t2\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tS367013402\tREFLECTOR-TURN-CONDO-RH\t1\t1\tNO\tHALB
5600\t3\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO02801402\tHEXAMETHYLDISILOXANE HMDSO\t60\t0.060\tG\tROH
5600\t3\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tS367013404\tREFLECTOR-TURN-CONDO-RH-1W\t1\t1\tNO\tHALB
5600\t4\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tRM01220107\tTHERMOPLAST-PBT TORAYCON\t224\t224\tKG\tROH
5600\t1\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO02601474\tCLOSEOUT-GAP HIDER-LH\t1\t1\tNO\tROH
5600\t1\tS367015500\tLAMP ASM HL CONDOR RHD RH 24V\tBO01303604\tVNT ASY HD LP\t2\t2\tNO\tROH
5600\t1\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tBO00100587\tSIKAMELT-700\t39\t39\tKG\tROH
5600\t1\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tS3670154F3\tHSG ASM-HL-CONDOR-RHD-LH-24V\t1\t1\tNO\tHALB
5600\t2\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tBO01610117\tSCREW-ADJUSTER-HORIZONTAL CAP\t1\t1\tNO\tROH
5600\t2\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tBO01610118\tLEVER-ADJUSTER-MOTOR\t1\t1\tNO\tROH
5600\t2\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tS3670154F2\tREF ASSY-HL-CONDOR-RHD-LH-24V\t1\t1\tNO\tHALB
5600\t3\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tBO02907174\tPIVOT BUSH\t1\t1\tNO\tROH
5600\t3\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tS367015416\tREF-HL-LD-CONDOR-RHD-LH\t1\t1\tNO\tHALB
5600\t4\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tS367015414\tREF-HL-LD-CONDOR-RHD-LH-2W\t1\t1\tNO\tHALB
5600\t5\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tBO02801400\tSOLVENT BASECOAT-BUTYL ACETATE\t28\t28\tL\tROH
5600\t6\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tRM01220116\tBMC 3100 7250-10A 109 LD\t638\t638\tKG\tROH
5600\t1\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tBO01610017\tBRKT-MOUNTING-CONDOR HL-LH\t1\t1\tNO\tROH
5600\t1\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tS3670154F1\tLENS ASSEMBLY-HL-CONDO-LH\t1\t1\tNO\tHALB
5600\t2\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tS367015402\tLENS-OTR HL-CONDO-LH\t1\t1\tNO\tHALB
5600\t3\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tBO02801410\tUVHC3000 HARD COAT\t11\t11\tG\tROH
5600\t3\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tS367015406\tLENS-OTR HL-CONDO-LH-1W\t1\t1\tNO\tHALB
5600\t4\tS367015400\tLAMP ASM HL CONDO RHD LH 24V\tRM01220080\tMAKROLON AL2647 CLEAR\t474\t474\tKG\tROH
5600\t1\tS367010900\tLAMP ASM HL VE3100 RHD LH 24V\tBO00100587\tSIKAMELT-700\t29\t29\tKG\tROH
5600\t1\tS367010900\tLAMP ASM HL VE3100 RHD LH 24V\tS3670109F3\tHSG ASSY-HL-VE3100-RHD-LH-24V\t1\t1\tNO\tHALB
5600\t2\tS367010900\tLAMP ASM HL VE3100 RHD LH 24V\tS3670109F5\tREF ASM-HL-VE3100-HB-LH-24V\t1\t1\tNO\tHALB
5600\t3\tS367010900\tLAMP ASM HL VE3100 RHD LH 24V\tS367010518\tREF-HIGH BEAM-VE3100-LH\t1\t1\tNO\tHALB
5600\t4\tS367010900\tLAMP ASM HL VE3100 RHD LH 24V\tBO02801404\tUNCLAD-AL WIRE 1.4MM DIA\t100\t0.100\tG\tROH
5600\t4\tS367010900\tLAMP ASM HL VE3100 RHD LH 24V\tS367010522\tREF-HB-VE3100-RHD-LH-2W\t1\t1\tNO\tHALB
5600\t5\tS367010900\tLAMP ASM HL VE3100 RHD LH 24V\tBO02912902\tREFLECTOR-HB-VE3100-RHD-LH-1W\t1\t1\tNO\tROH
5600\t2\tS367010900\tLAMP ASM HL VE3100 RHD LH 24V\tS367010514\tHOUSING-HEADLAMP-VE3100-LH\t1\t1\tNO\tHALB
5600\t3\tS367010900\tLAMP ASM HL VE3100 RHD LH 24V\tRM01220062\tPPTD XPP 1804 BLACK\t756\t756\tKG\tROH
5600\t1\tS367010900\tLAMP ASM HL VE3100 RHD LH 24V\tBO00800395\tBLB-BAYONET S8 W3 PY21W 24V\t1\t1\tNO\tROH
5600\t1\tS367010900\tLAMP ASM HL VE3100 RHD LH 24V\tBO01610236\tVENT ASSEMBLY-TUBE ARIA\t5\t5\tNO\tROH`;

function loadSample(){document.getElementById('raw').value=SAMPLE;toast('Sample data loaded');}

document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){document.getElementById('search').value='';doSearch('');}
  if((e.ctrlKey||e.metaKey)&&e.key==='f'){e.preventDefault();document.getElementById('search').focus();}
});
</script>
</body>
</html>
